@component-name = "portal-business-productivity-ee"
definition {
	property portal.release = "true";
	property portal.upstream = "true";
	property test.run.environment = "EE";
	property testray.main.component.name = "Kaleo Forms Admin";

	setUp {
		TestCase.setUpPortalInstance();

		User.firstLoginPG();

		ProductMenu.gotoPortlet(
			category = "Configuration",
			panel = "Control Panel",
			portlet = "Workflow Definition"
		);

		Workflow.uploadDefinition(
			workflowDefinitionFile = "workflow_definition_xss.xml",
			workflowDefinitionTitle = '''<script>alert(123);</script>'''
		);

		Navigator.openURL();

		Navigator.openURL();

		ProductMenu.gotoPortlet(
			category = "Content",
			panel = "Site Administration",
			portlet = "Kaleo Forms Admin"
		);
	}

	tearDown {
		var testPortalInstance = PropsUtil.get("test.portal.instance");

		if ("${testPortalInstance}" == "true") {
			PortalInstances.tearDownCP();
		}
		else {
			User.firstLoginPG();

			KaleoFormsAdmin.tearDownProcess();

			KaleoFormsAdmin.deleteFieldSet();

			Page.tearDownPG();

			Workflow.tearDownWorkflowDefinitionsViaWorkflowCP();
		}
	}

	@priority = "4"
	test AddProcess {
		KaleoFormsAdmin.addProcess();

		AssertAlertNotPresent();

		var actualScript = '''<script>alert(123);</script>''';

		var escapedScript = '''&lt;script&gt;alert(123);&lt;/script&gt;''';

		AssertHTMLSourceTextNotPresent(value1 = "${actualScript}");

		AssertHTMLSourceTextPresent(value1 = "${escapedScript}");

		KaleoFormsAdmin.addProcessDetails(
			kfProcessDescription = "Kaleo Forms Process Description",
			kfProcessName = "Kaleo Forms Process"
		);

		KaleoFormsAdmin.next();

		KaleoFormsAdmin.addFieldSet(
			kfFieldSetName = "New Kaleo Field Set",
			kfProcessName = "Kaleo Forms Process"
		);

		DynamicDataMapping.addField(
			field = "Text",
			fieldFieldLabel = "Text",
			fieldName = "Text"
		);

		KaleoFormsAdmin.saveFieldSet();

		KaleoFormsAdmin.chooseFieldSet(
			kfFieldSetName = "New Kaleo Field Set",
			kfProcessName = "Kaleo Forms Process"
		);

		KaleoFormsAdmin.next();

		AssertAlertNotPresent();

		var actualScript = '''<script>alert(123);</script>''';

		var escapedScript = '''&lt;script&gt;alert(123);&lt;/script&gt;''';

		AssertHTMLSourceTextNotPresent(value1 = "${actualScript}");

		AssertHTMLSourceTextPresent(value1 = "${escapedScript}");

		LexiconEntry.gotoEntryMenuItem(menuItem = "Choose", rowEntry = "alert");

		KaleoFormsAdmin.next();

		KaleoFormsAdmin.assignForm(
			kfProcessName = "Kaleo Forms Process",
			workflowTask = "StartNode"
		);

		KaleoFormsAdmin.addForm(kfFormName = "Created Task Form");

		KaleoFormsAdmin.saveForm();

		KaleoFormsAdmin.assignForm(
			kfProcessName = "Kaleo Forms Process",
			workflowTask = "StartNode"
		);

		KaleoFormsAdmin.chooseForm(kfFormName = "Created Task Form");

		KaleoFormsAdmin.saveProcess(kfProcessName = "Kaleo Forms Process");
	}
}