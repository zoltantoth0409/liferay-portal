@component-name = "portal-staging"
definition {
	property portal.release = "true";
	property portal.upstream = "true";
	property testray.main.component.name = "Staging";

	setUp {
		TestCase.setUpPortalInstance();

		User.firstLoginPG();

		ProductMenu.gotoPortlet(
			category = "Sites",
			panel = "Control Panel",
			portlet = "Sites"
		);
	}

	tearDown {
		var testPortalInstance = PropsUtil.get("test.portal.instance");

		if ("${testPortalInstance}" == "true") {
			PortalInstances.tearDownCP();
		}
		else {
			User.tearDownCP();

			Role.tearDownCP();

			Organization.tearDownCP();
		}
	}

	@priority = "3"
	test BlogsOrganizationWorkflowStaging {
		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		Role.definePermissionCP(
			permissionDefinitionKey = "SITE_ADMIN_CONTENT_BLOGS_RESOURCE_PERMISSIONS_BLOGS_ENTRIES_ADD_ENTRY_CHECKBOX",
			permissionDefinitionValue = "Add Entry",
			permissionNavigationKey = "SITE_ADMIN_CONTENT_BLOGS",
			permissionNavigationValue = "Blogs",
			roleName = "Organization User",
			roleType = "Organization"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		Role.definePermissionCP(
			permissionDefinitionKey = "SITE_ADMIN_PAGES_SITE_PAGES_RESOURCE_PERMISSIONS_SITE_MANAGE_PAGES_CHECKBOX",
			permissionDefinitionValue = "Manage Pages",
			permissionNavigationKey = "SITE_ADMIN_PAGES_SITE_PAGES",
			permissionNavigationValue = "Site Pages",
			roleName = "Organization User",
			roleType = "Organization"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		Organization.addCP(orgName = "Organization Name", orgType = "Organization");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.addSiteCP(orgName = "Organization Name");

		ProductMenu.gotoPortlet(
			category = "Sites",
			panel = "Control Panel",
			portlet = "Sites"
		);

		Page.add(pageName = "Staging Test Page", siteName = "Organization Name");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea@liferay.com",
			userFirstName = "userfn",
			userLastName = "userln",
			userScreenName = "usersn"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.editPasswordCP(
			password = "password",
			userEmailAddress = "userea@liferay.com",
			userScreenName = "usersn"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.addMemberCP(
			orgName = "Organization Name",
			userFirstName = "userfn",
			userLastName = "userln",
			userScreenName = "usersn"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "usereacr@liferay.com",
			userFirstName = "userfncr",
			userLastName = "userlncr",
			userScreenName = "usersncr"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.editPasswordCP(
			password = "password",
			userEmailAddress = "usereacr@liferay.com",
			userScreenName = "usersncr"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.addMemberCP(
			orgName = "Organization Name",
			userFirstName = "userfncr",
			userLastName = "userlncr",
			userScreenName = "usersncr"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.assignOrgRoleCP(
			orgName = "Organization Name",
			roleName = "Organization Content Reviewer",
			userFirstName = "userfncr",
			userLastName = "userlncr",
			userScreenName = "usersncr"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "usereaoa@liferay.com",
			userFirstName = "userfnoa",
			userLastName = "userlnoa",
			userScreenName = "usersnoa"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.editPasswordCP(
			password = "password",
			userEmailAddress = "usereaoa@liferay.com",
			userScreenName = "usersnoa"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.addMemberCP(
			orgName = "Organization Name",
			userFirstName = "userfnoa",
			userLastName = "userlnoa",
			userScreenName = "usersnoa"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.assignOrgRoleCP(
			orgName = "Organization Name",
			roleName = "Organization Administrator",
			userFirstName = "userfnoa",
			userLastName = "userlnoa",
			userScreenName = "usersnoa"
		);

		Navigator.openSiteURL(siteName = "Organization Name");

		ProductMenu.gotoPortlet(
			category = "Publishing",
			panel = "Site Administration",
			portlet = "Staging"
		);

		Staging.activateStagingCP(siteName = "Organization Name");

		Navigator.openSiteURL(siteName = "Organization Name");

		Navigator.gotoStagedView();

		ProductMenu.gotoPortlet(
			category = "Configuration",
			panel = "Site Administration",
			portlet = "Workflow Configuration"
		);

		Workflow.configureWorkflow(
			workflowDefinition = "Single Approver (Version 1)",
			workflowResourceValue = "Blogs Entry"
		);

		User.logoutAndLoginPG(
			userLoginEmailAddress = "userea@liferay.com",
			userLoginFullName = "userfn userln"
		);

		Navigator.gotoStagedSitePage(
			pageName = "Staging Test Page",
			siteName = "Organization Name"
		);

		Portlet.addPG(pageName = "Staging Test Page", portletName = "Blogs");

		User.logoutUserPG();

		Navigator.openSiteURL(siteName = "Organization Name");

		AssertElementNotPresent(locator1 = "Portlet#TITLE", key_portletName = "Blogs");

		User.loginPG(password = "test", userEmailAddress = "usereaoa@liferay.com");

		Navigator.gotoStagedSitePage(
			pageName = "Staging Test Page",
			siteName = "Organization Name"
		);

		Staging.gotoPublishToLive();

		Staging.publishToLive();

		User.logoutUserPG();

		Navigator.openSiteURL(siteName = "Organization Name");

		AssertElementPresent(locator1 = "Portlet#TITLE", key_portletName = "Blogs");

		User.loginPG(password = "test", userEmailAddress = "userea@liferay.com");

		Navigator.gotoStagedSitePage(
			pageName = "Staging Test Page",
			siteName = "Organization Name"
		);

		BlogsEntry.addWithWorkflowPG(
			entryContent = "Blogs Entry Content",
			entryTitle = "Blogs Entry Title"
		);

		User.logoutUserPG();

		Navigator.openSiteURL(siteName = "Organization Name");

		AssertElementNotPresent(
			locator1 = "BlogsEntry#TITLE",
			key_entryTitle = "Blogs Entry Title"
		);

		User.loginPG(password = "test", userEmailAddress = "usereacr@liferay.com");

		Page.gotoMyAccount(portletName = "My Workflow Tasks");

		Workflow.assignToMeTaskByActions(
			workflowAssetTitle = "Blogs Entry Title",
			workflowAssetType = "Blogs Entry",
			workflowTask = "Review"
		);

		Workflow.approveTaskByActions(
			workflowAssetTitle = "Blogs Entry Title",
			workflowAssetType = "Blogs Entry",
			workflowTask = "Review"
		);

		User.logoutUserPG();

		Navigator.openSiteURL(siteName = "Organization Name");

		AssertElementNotPresent(
			locator1 = "BlogsEntry#TITLE",
			key_entryTitle = "Blogs Entry Title"
		);

		User.loginPG(password = "test", userEmailAddress = "usereaoa@liferay.com");

		Navigator.gotoStagedSitePage(
			pageName = "Staging Test Page",
			siteName = "Organization Name"
		);

		Staging.gotoPublishToLive();

		Staging.publishToLive();

		User.logoutUserPG();

		Navigator.openSiteURL(siteName = "Organization Name");

		AssertElementPresent(
			locator1 = "BlogsEntry#TITLE",
			key_entryTitle = "Blogs Entry Title"
		);

		User.loginPG(password = "test", userEmailAddress = "test@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		Role.removePermissionCP(
			permissionDefinitionKey = "SITE_ADMIN_CONTENT_BLOGS_RESOURCE_PERMISSIONS_BLOGS_ENTRIES_ADD_ENTRY_CHECKBOX",
			permissionDefinitionValue = "Add Entry",
			permissionNavigationKey = "SITE_ADMIN_CONTENT_BLOGS",
			permissionNavigationValue = "Blogs",
			roleName = "Organization User",
			roleType = "Organization"
		);
	}
}