<?xml version="1.0"?>

<project basedir="." name="portal-test-batch" xmlns:antelope="antlib:ise.antelope.tasks" xmlns:if="ant:if" xmlns:unless="ant:unless">
	<import file="build-test.xml" />

	<condition else="0" property="axis.variable" value="${env.AXIS_VARIABLE}">
		<isset property="env.AXIS_VARIABLE" />
	</condition>

	<macrodef name="check-jenkins-console">
		<sequential>
			<if>
				<isset property="env.BUILD_URL" />
				<then>
					<var name="tstamp.value" unset="true" />

					<tstamp>
						<format pattern="yyyyMMddkkmmssSSS" property="tstamp.value" />
					</tstamp>

					<propertyregex
						input="${env.BUILD_URL}"
						property="jenkins.build.url"
						regexp="https:\/\/([^\.]+)\.[^\/]+"
						replace="http://\1"
					/>

					<propertyregex
						input="${jenkins.build.url}"
						override="true"
						property="jenkins.build.url"
						regexp="http:\/\/([^\/]+)\/(\d+)"
						replace="http://\1-\2/\2"
					/>

					<get
						dest="${tstamp.value}.txt"
						ignoreerrors="true"
						src="${jenkins.build.url}/consoleText"
					/>

					<var name="jenkins.console.txt" unset="true" />

					<loadfile
						property="jenkins.console.txt"
						srcfile="${tstamp.value}.txt"
					/>

					<delete file="${tstamp.value}.txt" />

					<var name="tstamp.value" unset="true" />

					<var name="junit.failure.count" unset="true" />
					<var name="junit.failure.message" unset="true" />
					<var name="junit.timestamp" unset="true" />

					<if>
						<contains string="${jenkins.console.txt}" substring="!MESSAGE error" />
						<then>
							<property name="junit.failure.count" value="1" />
							<property name="junit.failure.message"><![CDATA[<failure message="!MESSAGE error" type="java.lang.Exception" />]]></property>
						</then>
						<elseif>
							<contains string="${jenkins.console.txt}" substring="!MESSAGE warning" />
							<then>
								<property name="junit.failure.count" value="1" />
								<property name="junit.failure.message"><![CDATA[<failure message="!MESSAGE warning" type="java.lang.Exception" />]]></property>
							</then>
						</elseif>
						<else>
							<property name="junit.failure.count" value="0" />
							<property name="junit.failure.message" value="" />
						</else>
					</if>

					<tstamp>
						<format pattern="yyyy-MM-dd_kk:mm:ss" property="junit.timestamp" />
					</tstamp>

					<echo file="portal-impl/test-results/TEST-JenkinsLogAssertTest.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>

<testsuite errors="0" failures="${junit.failure.count}" hostname="localhost" name="com.liferay.jenkins.JenkinsLogAsserterTest" skipped="0" tests="1" time="0.0" timestamp="${junit.timestamp}">
	<properties />
	<testcase classname="com.liferay.jenkins.JenkinsLogAsserterTest" name="testScanJenkinsLog" time="0.0">
		${junit.failure.message}
	</testcase>
	<system-out></system-out>
	<system-err></system-err>
</testsuite>]]></echo>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="clean-restart-sybase">
		<attribute default="false" name="retry" />
		<sequential>
			<exec executable="service">
				<arg line="sybase stop" />
			</exec>

			<waitfor maxwait="60" maxwaitunit="second">
				<not>
					<socket port="5000" server="localhost" />
				</not>
			</waitfor>

			<sleep if:true="@{retry}" seconds="10" />

			<antcall target="clean-up-sybase-processes" />

			<if if:true="@{retry}">
				<available file="/opt/sybase.tar.gz" />
				<then>
					<delete dir="/opt/sybase" />

					<exec executable="tar" failonerror="true">
						<arg line="xf /opt/sybase.tar.gz -C /" />
					</exec>

					<exec executable="hostname" failonerror="true" outputproperty="hostname" />

					<echo file="/opt/sybase/interfaces">lportal
		master tcp ether ${hostname} 5000
		query tcp ether ${hostname} 5000

lportal_BS
		master tcp ether ${hostname} 5001
		query tcp ether ${hostname} 5001
					</echo>
				</then>
				<else>
					<fail message="Unable to reset Sybase installation due to missing /opt/sybase.tar.gz." />
				</else>
			</if>

			<exec executable="service" failonerror="true">
				<arg line="sybase start" />
			</exec>

			<waitfor maxwait="60" maxwaitunit="second">
				<socket port="5000" server="localhost" />
			</waitfor>

			<sleep if:true="@{retry}" seconds="10" />
		</sequential>
	</macrodef>

	<macrodef name="copy-artifact-to-local-cache">
		<attribute name="artifact.file" />
		<attribute name="artifact.name" />
		<attribute name="artifact.version" />

		<sequential>
			<local name="local.cache.artifact" />

			<beanshell>
				<![CDATA[
					String artifactName = "@{artifact.name}";
					String artifactVersion = "@{artifact.version}";

					StringBuilder sb = new StringBuilder();

					sb.append(project.getProperty("build.repository.local.dir"));
					sb.append("/com/liferay/portal/");
					sb.append(artifactName);
					sb.append("/");
					sb.append(artifactVersion);
					sb.append("/");
					sb.append(artifactName);
					sb.append("-");
					sb.append(artifactVersion);
					sb.append(".jar");

					project.setProperty("local.cache.artifact", sb.toString());
				]]>
			</beanshell>

			<copy
				failonerror="false"
				file="@{artifact.file}"
				tofile="${local.cache.artifact}"
			/>

			<propertyfile file="${project.dir}/.gradle/gradle.properties">
				<entry key="@{artifact.name}.version" value="@{artifact.version}" />
			</propertyfile>
		</sequential>
	</macrodef>

	<macrodef name="database-test-action">
		<attribute name="database.type" />
		<element name="action" />

		<sequential>
			<local name="database.type" />

			<property name="database.type" value="@{database.type}" />

			<local name="database.service.executable" />

			<get-database-property property.name="database.service.executable" />

			<local name="database.service.cmd.start" />

			<get-database-property property.name="database.service.cmd.start" />

			<local name="database.service.cmd.stop" />

			<get-database-property property.name="database.service.cmd.stop" />

			<local name="database.version.cmd" />

			<get-database-property property.name="database.version.cmd" />

			<action />
		</sequential>
	</macrodef>

	<macrodef name="database-test-run-test">
		<attribute name="database.type" />
		<attribute default="" name="database.version" />
		<attribute default="true" name="rebuild.database" />
		<attribute default="false" name="stop.app.server" />
		<element name="test-action" />

		<sequential>
			<var name="database.type" unset="true" />

			<property name="database.type" value="@{database.type}" />

			<echo append="true" file="test.${env.HOSTNAME}.properties"><![CDATA[
database.type=@{database.type}]]></echo>

			<if>
				<not>
					<equals arg1="@{database.version}" arg2="" />
				</not>
				<then>
					<var name="database.@{database.type}.version" unset="true" />

					<property name="database.@{database.type}.version" value="@{database.version}" />

					<echo append="true" file="test.${env.HOSTNAME}.properties"><![CDATA[
database.@{database.type}.version=@{database.version}]]></echo>
				</then>
			</if>

			<if>
				<and>
					<equals arg1="@{database.type}" arg2="mysql" />
					<or>
						<equals arg1="@{database.version}" arg2="5.5" />
						<equals arg1="@{database.version}" arg2="5.7" />
					</or>
				</and>
				<then>
					<var name="database.major.version.build" unset="true" />
					<var name="database.mysql.service.cmd.start" unset="true" />
					<var name="database.mysql.service.cmd.stop" unset="true" />
					<var name="mysql.executable" unset="true" />

					<antelope:stringutil property="database.major.version.build" string="@{database.version}">
						<antelope:replace regex="\." replacement="" />
					</antelope:stringutil>

					<property name="database.mysql.service.cmd.start" value="mysql${database.major.version.build} start" />
					<property name="database.mysql.service.cmd.stop" value="mysql${database.major.version.build} stop" />
					<property name="mysql.executable" value="mysql${database.major.version.build}" />

					<echo append="true" file="test.${env.HOSTNAME}.properties"><![CDATA[
database.mysql.service.cmd.start=${database.mysql.service.cmd.start}
database.mysql.service.cmd.stop=${database.mysql.service.cmd.stop}]]></echo>

					<echo append="true" file="sql/sql.${env.HOSTNAME}.properties"><![CDATA[
mysql.executable=${mysql.executable}]]></echo>
				</then>
			</if>

			<if>
				<equals arg1="@{database.type}" arg2="mariadb" />
				<then>
					<var name="mariadb.executable" unset="true" />

					<property name="mariadb.executable" value="mariadb" />

					<echo append="true" file="sql/sql.${env.HOSTNAME}.properties"><![CDATA[
mariadb.executable=${mariadb.executable}]]></echo>
				</then>
			</if>

			<print-file file.name="sql/sql.${env.HOSTNAME}.properties" />

			<database-test-action database.type="@{database.type}">
				<action>
					<if>
						<equals arg1="${env.DOCKER_ENABLED}" arg2="true" />
						<then>
							<echo>Using Docker for ${database.type}.</echo>
						</then>
						<elseif>
							<equals arg1="${database.type}" arg2="db2" />
							<then>
								<echo></echo>
								<echo>##</echo>
								<echo>## ${database.version.cmd}</echo>
								<echo>##</echo>
								<echo></echo>

								<exec executable="${database.version.cmd}" />
							</then>
						</elseif>
						<else>
							<local name="database.executable" />

							<if>
								<equals arg1="${database.type}" arg2="oracle" />
								<then>
									<propertycopy from="oracle.sqlplus.executable" name="database.executable" />
								</then>
								<else>
									<propertycopy from="${database.type}.executable" name="database.executable" />
								</else>
							</if>

							<echo></echo>
							<echo>##</echo>
							<echo>## ${database.executable} ${database.version.cmd}</echo>
							<echo>##</echo>
							<echo></echo>

							<exec executable="${database.executable}">
								<arg line="${database.version.cmd}" />
							</exec>
						</else>
					</if>
				</action>
			</database-test-action>

			<database-test-action database.type="@{database.type}">
				<action>
					<if>
						<and>
							<equals arg1="${env.DOCKER_ENABLED}" arg2="true" />
							<not>
								<equals arg1="${database.type}" arg2="hypersonic" />
							</not>
						</and>
						<then>
							<stop-docker-database />
						</then>
						<else>
							<exec executable="${database.service.executable}">
								<arg line="${database.service.cmd.stop}" />
							</exec>
						</else>
					</if>
				</action>
			</database-test-action>

			<database-test-action database.type="@{database.type}">
				<action>
					<set-portal-impl-portal-test-ext-properties />

					<set-portal-impl-system-ext-properties />

					<if>
						<and>
							<equals arg1="${env.DOCKER_ENABLED}" arg2="true" />
							<not>
								<equals arg1="${database.type}" arg2="hypersonic" />
							</not>
						</and>
						<then>
							<start-docker-database />
						</then>
						<elseif>
							<or>
								<and>
									<equals arg1="@{database.type}" arg2="oracle" />
									<equals arg1="@{database.version}" arg2="19.3.0.0.0" />
								</and>
								<and>
									<equals arg1="@{database.type}" arg2="postgresql" />
									<equals arg1="@{database.version}" arg2="11" />
								</and>
							</or>
							<then>
								<fail message="Unsupported database: @{database.type}-@{database.version}" />
							</then>
						</elseif>
						<else>
							<exec executable="${database.service.executable}" resultproperty="exec.result">
								<arg line="${database.service.cmd.start}" />
							</exec>

							<diagnose-database-start database.type="@{database.type}" exec.result="${exec.result}" />
						</else>
					</if>

					<antcall inheritall="false" target="copy-optional-jars">
						<param name="database.type" value="@{database.type}" />
						<param name="todir" value="lib/development" />
					</antcall>

					<local name="test.app.server.lib.global.dir" />

					<propertycopy from="app.server.${app.server.type}.lib.global.dir" name="test.app.server.lib.global.dir" />

					<antcall inheritall="false" target="copy-optional-jars">
						<param name="database.type" value="@{database.type}" />
						<param name="todir" value="${test.app.server.lib.global.dir}" />
					</antcall>

					<antcall if:true="@{rebuild.database}" inheritall="false" target="rebuild-database">
						<param name="database.type" value="@{database.type}" />
					</antcall>

					<test-action />

					<if if:true="@{stop.app.server}">
						<available file=".testable.portal.started" />
						<then>
							<antcall target="stop-app-server" />

							<delete failonerror="false" file=".testable.portal.started" />
						</then>
					</if>

					<if>
						<and>
							<equals arg1="${env.DOCKER_ENABLED}" arg2="true" />
							<not>
								<equals arg1="${database.type}" arg2="hypersonic" />
							</not>
						</and>
						<then>
							<stop-docker-database />
						</then>
						<else>
							<exec executable="${database.service.executable}" failonerror="true">
								<arg line="${database.service.cmd.stop}" />
							</exec>
						</else>
					</if>
				</action>
			</database-test-action>
		</sequential>
	</macrodef>

	<macrodef name="deploy-release-dependency-modules">
		<sequential>
			<beanshell>
				<![CDATA[
					import org.apache.commons.io.FileUtils;

					import org.apache.commons.lang.StringUtils;

					String projectDir = project.getProperty("project.dir");

					public List findFiles(File baseDir, String regex) {
						List files = new ArrayList();

						for (File file : baseDir.listFiles()) {
							String filePath = file.toString();

							if (file.isDirectory()) {
								files.addAll(findFiles(file, regex));
							}
							else if (filePath.matches(regex)) {
								files.add(file);
							}
						}

						return files;
					}

					public List getModulesFromModuleGroups(String[] moduleGroups) {
						List modules = new ArrayList();

						for (String moduleGroup : moduleGroups) {
							String moduleGroupPath = projectDir + "/" + moduleGroup;

							File appBndFile = new File(moduleGroupPath, "app.bnd");

							if (!appBndFile.exists()) {
								modules.add(moduleGroup);

								continue;
							}

							List moduleBuildGradleFiles = findFiles(new File(moduleGroupPath), moduleGroupPath + "/.+/build.gradle");

							for (File moduleBuildGradleFile : moduleBuildGradleFiles) {
								String module = moduleBuildGradleFile.getParent();

								module = module.replace(projectDir + "/", "");

								if (module.endsWith("-test")) {
									System.out.println("Ignoring " + module);

									continue;
								}

								modules.add(module);
							}
						}

						return modules;
					}

					public List getTestUtilModules() {
						List appBndFiles = findFiles(new File(projectDir, "modules/apps"), ".+/app.bnd");

						File dxpAppsDir = new File(projectDir, "modules/dxp/apps");

						if (dxpAppsDir.exists()) {
							appBndFiles.addAll(findFiles(dxpAppsDir, ".+/app.bnd"));
						}

						File privateAppsDir = new File(projectDir, "modules/private/apps");

						if (privateAppsDir.exists()) {
							appBndFiles.addAll(findFiles(privateAppsDir, ".+/app.bnd"));
						}

						List releasedAppDirs = new ArrayList();

						for (File appBndFile : appBndFiles) {
							String fileContent = FileUtils.readFileToString(appBndFile);

							if (fileContent.contains("Liferay-Releng-Bundle: true")) {
								releasedAppDirs.add(appBndFile.getParentFile());
							}
						}

						List testUtilModules = new ArrayList();

						for (File releasedAppDir : releasedAppDirs) {
							List testUtilModuleBuildGradleFiles = findFiles(releasedAppDir, ".+test-util/build.gradle");

							for (File testUtilModuleBuildGradleFile : testUtilModuleBuildGradleFiles) {
								String testUtilModule = testUtilModuleBuildGradleFile.getParent();

								File skipTestIntegrationCheckFile = new File(testUtilModule, ".lfrbuild-ci-skip-test-integration-check");

								if (skipTestIntegrationCheckFile.exists()) {
									System.out.println("Ignoring " + testUtilModule.replace(projectDir + "/", ""));

									continue;
								}

								testUtilModule = testUtilModule.replace(projectDir + "/", "");

								testUtilModules.add(testUtilModule);
							}
						}

						return testUtilModules;
					}

					Set releaseDependentModules = new TreeSet();

					releaseDependentModules.addAll(getTestUtilModules());

					String deprecatedModuleGroups = project.getProperty("test.batch.deprecated.module.groups");

					if (deprecatedModuleGroups != null) {
						releaseDependentModules.addAll(getModulesFromModuleGroups(deprecatedModuleGroups.split(",")));
					}

					project.setProperty("release.dependency.modules", StringUtils.join(releaseDependentModules, ','));
				]]>
			</beanshell>

			<for list="${release.dependency.modules}" param="release.dependency.module">
				<sequential>
					<if>
						<available file="@{release.dependency.module}" />
						<then>
							<echo>Deploying @{release.dependency.module}</echo>

							<gradle-execute dir="@{release.dependency.module}" forcedcacheenabled="false" task="deploy" />
						</then>
					</if>
				</sequential>
			</for>
		</sequential>
	</macrodef>

	<macrodef name="diagnose-database-start">
		<attribute name="database.type" />
		<attribute name="exec.result" />

		<sequential>
			<if>
				<equals arg1="@{database.type}" arg2="db2" />
				<then>
					<if>
						<not>
							<equals arg1="@{exec.result}" arg2="0" />
						</not>
						<then>
							<exec executable="db2diag">
								<arg line="-H 1d" />
							</exec>
						</then>
					</if>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="get-test-batch-app-server-start-executable-arg-line">
		<sequential>
			<propertycopy from="app.server.${app.server.type}.start.executable.arg.line" name="start.executable.arg.line" />

			<var name="test.batch.app.server.start.executable.arg.line" value="${start.executable.arg.line}" />

			<if>
				<and>
					<equals arg1="${app.server.type}" arg2="tomcat" />
					<equals arg1="${test.batch.aspectj.enabled}" arg2="true" />
					<not>
						<os family="windows" />
					</not>
				</and>
				<then>
					<var name="test.batch.app.server.start.executable.arg.line" value="aspectj ${test.batch.app.server.start.executable.arg.line}" />
				</then>
			</if>

			<if>
				<and>
					<equals arg1="${app.server.type}" arg2="tomcat" />
					<equals arg1="${test.batch.code.coverage}" arg2="true" />
					<not>
						<os family="windows" />
					</not>
				</and>
				<then>
					<var name="test.batch.app.server.start.executable.arg.line" value="jacoco ${test.batch.app.server.start.executable.arg.line}" />
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="merge-test-results">
		<sequential>
			<antcall target="merge-test-results" />

			<if>
				<isset property="env.WORKSPACE" />
				<then>
					<mkdir dir="${env.WORKSPACE}/test-results" />

					<copy
						file="test-results/TESTS-TestSuites.xml"
						tofile="${env.WORKSPACE}/test-results/TESTS-TestSuites.xml"
					/>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="prepare-liferay-classes">
		<attribute name="merged.jar" />
		<attribute name="portal.bundle.dir" />

		<sequential>
			<var name="merged-classes" value="${project.dir}/jacoco/merged-classes" />

			<delete dir="${merged-classes}" />
			<mkdir dir="${merged-classes}" />

			<unzip
				dest="${merged-classes}"
			>
				<patternset>
					<include name="**/com/liferay/**" />
				</patternset>
				<fileset
					dir="@{portal.bundle.dir}"
				>
					<include name="**/*.jar" />
					<include name="**/*.war" />
				</fileset>
			</unzip>

			<jar
				destfile="@{merged.jar}"
				update="true"
			>
				<fileset
					dir="${merged-classes}"
				>
					<include name="**/*.class" />
				</fileset>
			</jar>

			<delete dir="${merged-classes}" />
		</sequential>
	</macrodef>

	<macrodef name="prepare-release-test-environment">
		<attribute default="tomcat" name="app.server.type" />
		<attribute default="true" name="setup.testable.jboss" />
		<attribute default="true" name="setup.testable.tomcat" />
		<attribute default="" name="test.build.fix.pack.zip.url" />
		<attribute default="" name="test.fix.pack.base.url" />
		<attribute default="" name="test.license.xml.url" />
		<attribute default="" name="test.plugins.war.zip.url" />
		<attribute default="" name="test.portal.bundle.dependencies.zip.url" />
		<attribute default="" name="test.portal.bundle.osgi.zip.url" />
		<attribute default="" name="test.portal.bundle.tools.zip.url" />
		<attribute default="" name="test.portal.bundle.war.url" />
		<attribute name="test.portal.bundle.zip.url" />
		<attribute name="test.sql.zip.url" />

		<sequential>
			<propertycopy from="app.server.@{app.server.type}.bin.dir" name="test.app.server.bin.dir" />

			<antcall inheritAll="false" target="prepare-test-bundle">
				<param if:set="test.class" name="test.class" value="${test.class}" />
				<param name="app.server.type" value="@{app.server.type}" />
				<param name="test.app.server.bin.dir" value="${test.app.server.bin.dir}" />
				<param name="test.build.bundle.zip.url" value="@{test.portal.bundle.zip.url}" />
				<param name="test.build.fix.pack.zip.url" value="@{test.build.fix.pack.zip.url}" />
				<param name="test.build.portal.dependencies.zip.url" value="@{test.portal.bundle.dependencies.zip.url}" />
				<param name="test.build.portal.osgi.zip.url" value="@{test.portal.bundle.osgi.zip.url}" />
				<param name="test.build.portal.tools.zip.url" value="@{test.portal.bundle.tools.zip.url}" />
				<param name="test.build.portal.war.url" value="@{test.portal.bundle.war.url}" />
				<param name="test.fix.pack.base.url" value="@{test.fix.pack.base.url}" />
			</antcall>

			<if>
				<matches pattern="https?://" string="@{test.license.xml.url}" />
				<then>
					<var name="test.build.license.xml.zip.url" unset="true" />

					<property name="test.build.license.xml.zip.url" value="@{test.license.xml.url}" />

					<echo append="true" file="test.${env.HOSTNAME}.properties"><![CDATA[${line.separator}test.build.license.xml.zip.url=@{test.license.xml.url}]]></echo>
				</then>
			</if>

			<if>
				<not>
					<equals arg1="${test.deploy.license}" arg2="false" />
				</not>
				<then>
					<antcall target="deploy-license-xml" />
				</then>
			</if>

			<antcall target="deploy-sql-zip">
				<param name="test.sql.zip.url" value="@{test.sql.zip.url}" />
			</antcall>

			<antcall inheritAll="false" target="setup-libs" />

			<antcall inheritAll="false" target="setup-sdk" />

			<antcall inheritAll="false" target="setup-yarn" />

			<if>
				<and>
					<equals arg1="@{app.server.type}" arg2="jboss" />
					<equals arg1="@{setup.testable.jboss}" arg2="true" />
				</and>
				<then>
					<setup-testable-jboss />
				</then>
				<elseif>
					<and>
						<equals arg1="@{app.server.type}" arg2="tomcat" />
						<equals arg1="@{setup.testable.tomcat}" arg2="true" />
					</and>
					<then>
						<setup-test-batch-testable-tomcat
							setup.proxy="@{setup.proxy}"
							test.portal.bundle.version="${test.portal.bundle.version}"
						/>
					</then>
				</elseif>
			</if>

			<if>
				<matches pattern="https?://" string="@{test.plugins.war.zip.url}" />
				<then>
					<mirrors-get
						dest="plugins.war.zip"
						src="@{test.plugins.war.zip.url}"
					/>

					<unzip
						dest="."
						src="plugins.war.zip"
					>
						<mapper>
							<globmapper
								from="plugins/*"
								to="plugins/marketplace/*"
							/>
						</mapper>
					</unzip>

					<delete file="plugins.war.zip" />
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="prepare-suite-search-engine">
		<attribute name="suite.name" />

		<sequential>
			<propertycopy from="search.engine[@{suite.name}]" name="suite.search.engine" silent="true" />

			<if>
				<equals arg1="${suite.search.engine}" arg2="elasticsearch7" />
				<then>
					<ant antfile="build-test-elasticsearch7.xml" inheritAll="false" target="deploy-elasticsearch7" />
				</then>
				<elseif>
					<equals arg1="${suite.search.engine}" arg2="solr" />
					<then>
						<property name="com.liferay.portal.search.solr7.test.unit.started" value="true" />

						<ant antfile="build-test-solr.xml" target="prepare-solr-suite" />
					</then>
				</elseif>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="prepare-test-build">
		<sequential>
			<trycatch property="exception.message">
				<try>
					<antcall target="setup-libs" />

					<antcall target="prepare-test-build">
						<param name="test.class.groups.size" value="${test.batch.size}" />
						<param name="test.plugin.groups.size" value="${test.batch.size}" />
					</antcall>
				</try>
				<catch>
					<echo message="${exception.message}" />

					<fail message="Unable to prepare test build." />
				</catch>
			</trycatch>
		</sequential>
	</macrodef>

	<macrodef name="prepare-test-build-custom">
		<sequential>
			<trycatch property="exception.message">
				<try>
					<antcall target="setup-libs" />

					<antcall target="prepare-test-build-custom">
						<param name="app.server.type" value="${app.server.type}" />
					</antcall>
				</try>
				<catch>
					<echo message="${exception.message}" />

					<fail message="Unable to prepare test build." />
				</catch>
			</trycatch>
		</sequential>
	</macrodef>

	<macrodef name="prepare-test-build-dist">
		<attribute name="app.server.type" />

		<sequential>
			<lstopwatch action="start" name="prepare-test-build-dist.bundles.@{app.server.type}" />

			<var name="app.server.type" value="@{app.server.type}" />

			<echo append="true" file="app.server.${env.HOSTNAME}.properties"><![CDATA[
app.server.type=@{app.server.type}]]></echo>

			<record-git-commit-portal />

			<antcall inheritAll="false" target="compile" />

			<if>
				<or>
					<equals arg1="@{app.server.type}" arg2="weblogic" />
					<equals arg1="@{app.server.type}" arg2="websphere" />
				</or>
				<then>
					<antcall inheritAll="false" target="prepare-test-build-custom">
						<param name="app.server.type" value="@{app.server.type}" />
					</antcall>
				</then>
				<else>
					<lstopwatch action="start" name="prepare-test-build-dist.bundles.@{app.server.type}.build-dist" />

					<ant antfile="build-dist.xml" inheritAll="false" target="build-dist-@{app.server.type}" />

					<lstopwatch action="total" name="prepare-test-build-dist.bundles.@{app.server.type}.build-dist" />
				</else>
			</if>

			<antcall inheritAll="false" target="prepare-portal-ext-properties" />

			<antcall inheritAll="false" target="prepare-system-ext-properties" />

			<if>
				<equals arg1="@{app.server.type}" arg2="tomcat" />
				<then>
					<setup-test-batch-testable-tomcat />
				</then>
			</if>

			<prepare-elasticsearch-configuration />

			<lstopwatch action="start" name="prepare-test-build-dist.bundles.@{app.server.type}.compile-test" />

			<antcall inheritAll="false" target="compile-test" />

			<lstopwatch action="total" name="prepare-test-build-dist.bundles.@{app.server.type}.compile-test" />

			<lstopwatch action="start" name="prepare-test-build-dist.bundles.@{app.server.type}.compress" />

			<delete>
				<fileset
					dir="bundles"
					includes="*.zip"
				/>
			</delete>

			<if>
				<contains string="@{app.server.type}" substring="tomcat" />
				<then>
					<tar
						basedir="${project.dir}"
						compression="gzip"
						destfile="liferay-portal-source.tar.gz"
						excludes="${test.batch.dist.source.excludes}"
						includes="${test.batch.dist.source.includes}"
						longfile="posix"
					/>

					<prepare-liferay-classes if:true="${test.batch.code.coverage}" merged.jar="${project.dir}/jacoco/merged.jar" portal.bundle.dir="bundles" />
				</then>
			</if>

			<chmod
				perm="a+x"
				type="file"
			>
				<fileset
					dir="bundles"
				>
					<include name="**/*.sh" />
					<include name="**/bin/*" />
				</fileset>
			</chmod>

			<tar
				basedir="."
				compression="gzip"
				destfile="liferay-portal-bundle-@{app.server.type}.tar.gz"
				includes="bundles/**"
				longfile="posix"
			/>

			<execute>
				<![CDATA[
					tar --file=liferay-portal-bundle-@{app.server.type}.tar.gz --gzip --list --verbose
				]]>
			</execute>

			<lstopwatch action="total" name="prepare-test-build-dist.bundles.@{app.server.type}.compress" />

			<lstopwatch action="total" name="prepare-test-build-dist.bundles.@{app.server.type}" />
		</sequential>
	</macrodef>

	<macrodef name="prepare-test-environment">
		<attribute default="tomcat" name="app.server.type" />
		<attribute default="true" name="setup.testable.tomcat" />

		<sequential>
			<antcall inheritAll="false" target="setup-libs" />

			<antcall inheritAll="false" target="setup-sdk" />

			<antcall inheritAll="false" target="setup-yarn" />

			<untar
				compression="gzip"
				dest="."
				src="liferay-portal-source.tar.gz"
			/>

			<untar
				compression="gzip"
				dest="."
				src="liferay-portal-bundle-@{app.server.type}.tar.gz"
			/>

			<chmod
				perm="a+x"
				type="file"
			>
				<fileset
					dir="bundles"
				>
					<include name="**/*.sh" />
					<include name="**/bin/*" />
				</fileset>
			</chmod>

			<setup-libs />

			<setup-yarn />

			<antcall inheritAll="false" target="install-portal-snapshots" />

			<echo if:set="env.JENKINS_HOME">ANT_OPTS=${env.ANT_OPTS}</echo>

			<antcall if:set="env.JENKINS_HOME" inheritAll="false" target="clean-up-db2-processes" />
			<antcall if:set="env.JENKINS_HOME" inheritAll="false" target="clean-up-java-processes" />

			<if>
				<and>
					<equals arg1="@{app.server.type}" arg2="tomcat" />
					<equals arg1="@{setup.testable.tomcat}" arg2="true" />
				</and>
				<then>
					<copy
						overwrite="true"
						todir="${app.server.tomcat.dir}/bin/"
					>
						<fileset
							dir="tools/servers/tomcat/bin/"
							includes="setenv.*"
						/>
					</copy>

					<setup-test-batch-testable-tomcat
						setup.proxy="@{setup.proxy}"
						test.portal.bundle.version="${test.portal.bundle.version}"
					/>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="print-test-class-group">
		<attribute name="test.class.group.index" />

		<sequential>
			<property file="${project.dir}/test.class.file.names.properties" />

			<propertycopy from="TEST_CLASS_GROUP_@{test.class.group.index}" name="test.class.group" />

			<echo>TEST_CLASS_GROUP_@{test.class.group.index}=${test.class.group}</echo>
		</sequential>
	</macrodef>

	<macrodef name="run-archived-module-smoke">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<sequential>
								<antcall inheritAll="false" target="prepare-log4j-ext-xml">
									<param name="database.type" value="@{database.type}" />
								</antcall>

								<antcall inheritAll="false" target="prepare-portal-ext-properties">
									<param name="database.type" value="@{database.type}" />
								</antcall>

								<echo file="${app.server.classes.portal.dir}/system-ext.properties">log.sanitizer.enabled=false</echo>
							</sequential>

							<if>
								<resourcecount count="0" when="gt">
									<fileset
										dir="${project.dir}/modules"
										includes="**/.lfrbuild-portal-deprecated"
									/>
								</resourcecount>
								<then>
									<gradle-execute dir="${project.dir}/modules" task="deploy">
										<arg value="--parallel" />
										<arg value="-Ddeploy.only.profile=portal-deprecated" />
									</gradle-execute>
								</then>
							</if>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.class" value="PortalSmoke#Smoke" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-archived-modules-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-system-ext-properties" />

							<if>
								<resourcecount count="0" when="gt">
									<fileset
										dir="${project.dir}/modules"
										includes="**/.lfrbuild-portal-deprecated"
									/>
								</resourcecount>
								<then>
									<gradle-execute dir="${project.dir}/modules" task="deploy">
										<arg value="--parallel" />
										<arg value="-Ddeploy.only.profile=portal-deprecated" />
									</gradle-execute>
								</then>
							</if>

							<for param="app.dir">
								<path>
									<dirset
										dir="modules/apps/archived"
									>
										<exclude name="archived-modules-upgrade-test*" />
										<present targetdir="modules/apps/archived">
											<mapper
												from="*"
												to="*/src/test"
												type="glob"
											/>
										</present>
									</dirset>
								</path>

								<sequential>
									<gradle-execute dir="@{app.dir}" task="test">
										<arg value="--continue" />
										<arg value="-Dbuild.exclude.ant.plugin=true" />
										<arg value="-Djunit.code.coverage=${test.batch.code.coverage}" />
									</gradle-execute>
								</sequential>
							</for>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<for param="app.dir">
										<path>
											<dirset
												dir="modules/apps/archived"
											>
												<exclude name="archived-modules-upgrade-test*" />
												<present targetdir="modules/apps/archived">
													<mapper
														from="*"
														to="*/src/testIntegration"
														type="glob"
													/>
												</present>
											</dirset>
										</path>

										<sequential>
											<gradle-execute dir="@{app.dir}" refreshdependencies="@{refreshdependencies}" task="testIntegration">
												<arg value="--continue" />
												<arg value="-Dbuild.exclude.ant.plugin=true" />
											</gradle-execute>
										</sequential>
									</for>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-batch-test">
		<attribute default="false" name="tomcat.gc.log" />
		<attribute default="false" name="tsant.gc.log" />
		<element name="test-action" />
		<element name="test-set-up" optional="true" />
		<element name="test-tear-down" optional="true" />

		<sequential>
			<lstopwatch action="start" name="run.batch.test" />

			<antcall if:set="env.JENKINS_HOME" inheritAll="false" target="clean-up-java-processes" />

			<lstopwatch action="start" name="run.batch.test.setup" />

			<test-set-up />

			<lstopwatch action="total" name="run.batch.test.setup" />

			<trycatch property="job.failure.message">
				<try>
					<lstopwatch action="start" name="run.batch.test.action" />

					<test-action />
				</try>

				<finally>
					<lstopwatch action="total" name="run.batch.test.action" />

					<property name="job.failure.message" value="" />

					<echo>${job.failure.message}</echo>

					<check-jenkins-console />

					<merge-test-results />

					<lstopwatch action="start" name="run.batch.test.tear.down" />

					<test-tear-down />

					<lstopwatch action="total" name="run.batch.test.tear.down" />

					<print-gc-logs
						tomcat.gc.log="@{tomcat.gc.log}"
						tsant.gc.log="@{tsant.gc.log}"
					/>
				</finally>
			</trycatch>

			<lstopwatch action="total" name="run.batch.test" />
		</sequential>
	</macrodef>

	<macrodef name="run-bundle-blacklist-restart-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-system-ext-properties" />

							<property name="blacklist.cfg.name" value="com.liferay.portal.bundle.blacklist.internal.BundleBlacklistConfiguration.cfg" />

							<gradle-execute dir="modules/apps/static/portal-bundle-blacklist/portal-bundle-blacklist-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.BundleBlacklistSetUpBatchTest" />
								<arg value="-Dblacklist.cfg.name=${blacklist.cfg.name}" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-bundle-blacklist/portal-bundle-blacklist-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.BundleBlacklistVerifyUninstalledTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete file="${liferay.home}/osgi/configs/${blacklist.cfg.name}" />

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<gradle-execute dir="modules/apps/static/portal-bundle-blacklist/portal-bundle-blacklist-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.BundleBlacklistVerifyReinstalledTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-empty-temp-dir-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<trycatch>
								<try>
									<antcall inheritAll="false" target="prepare-log4j-ext-xml">
										<param name="database.type" value="@{database.type}" />
									</antcall>

									<antcall inheritAll="false" target="prepare-portal-ext-properties">
										<param name="database.type" value="@{database.type}" />
									</antcall>

									<antcall inheritAll="false" target="prepare-system-ext-properties" />

									<antcall inheritall="false" target="start-app-server" />
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<ant dir="portal-kernel" inheritAll="false" target="test-class">
								<property name="test.class" value="EmptyTempDirTest" />
							</ant>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-functional-test">
		<attribute name="app.server.type" />
		<attribute default="${app.server.@{app.server.type}.version}" name="app.server.version" />
		<attribute name="database.type" />
		<attribute default="${database.@{database.type}.version}" name="database.version" />
		<attribute default="true" name="setup.proxy" />
		<attribute default="true" name="setup.testable.jboss" />
		<attribute default="true" name="setup.testable.tomcat" />
		<attribute default="" name="test.build.fix.pack.zip.url" />
		<attribute default="" name="test.fix.pack.base.url" />
		<attribute default="" name="test.legacy.database.dump" />
		<attribute default="" name="test.license.xml.url" />
		<attribute default="" name="test.plugin.zip.url" />
		<attribute default="" name="test.plugins.war.zip.url" />
		<attribute default="false" name="test.portal.log.assert" />
		<attribute default="" name="test.portal.bundle.dependencies.zip.url" />
		<attribute default="" name="test.portal.bundle.osgi.zip.url" />
		<attribute default="" name="test.portal.bundle.tools.zip.url" />
		<attribute default="" name="test.portal.bundle.version" />
		<attribute default="" name="test.portal.bundle.war.url" />
		<attribute default="" name="test.portal.bundle.zip.url" />
		<attribute default="" name="test.portal.lpkg.name" />
		<attribute default="" name="test.sql.zip.url" />
		<attribute default="false" name="tomcat.gc.log" />
		<attribute default="false" name="tsant.gc.log" />

		<sequential>
			<var name="app.server.type" value="@{app.server.type}" />
			<var name="app.server.version" value="@{app.server.version}" />

			<if>
				<matches pattern="[A-z]+" string="${axis.variable}" />
				<then>
					<property name="test.class" value="${axis.variable}" />
				</then>
				<else>
					<property name="test.class" value="${run.test.case.method.group}_${axis.variable}" />
				</else>
			</if>

			<run-batch-test tomcat.gc.log="@{tomcat.gc.log}" tsant.gc.log="@{tsant.gc.log}">
				<test-action>
					<database-test-run-test database.type="@{database.type}" database.version="@{database.version}" rebuild.database="false">
						<test-action>
							<trycatch>
								<try>
									<get-test-batch-app-server-start-executable-arg-line />

									<ant antfile="build-test-${app.server.type}.xml" inheritAll="false" target="run-selenium-${app.server.type}">
										<property name="app.server.start.executable.arg.line" value="${test.batch.app.server.start.executable.arg.line}" />
										<property name="database.type" value="@{database.type}" />
										<property name="liferay.portal.bundle" value="@{test.portal.bundle.version}" />
										<property name="test.build.plugins.war.zip.url" value="@{test.plugins.war.zip.url}" />
										<property name="test.class" value="${test.class}" />
									</ant>

									<if>
										<equals arg1="@{test.legacy.database.dump}" arg2="true" />
										<then>
											<get-testcase-property property.name="data.archive.type" />

											<ant dir="${portal.legacy.dir}" target="export-database">
												<property name="data.archive.type" value="${data.archive.type}" />
												<property name="database.type" value="@{database.type}" />
												<property name="database.version" value="@{database.version}" />
												<property name="test.class" value="${test.class}" />
											</ant>
										</then>
									</if>
								</try>
								<finally>
									<if>
										<equals arg1="@{test.portal.log.assert}" arg2="true" />
										<then>
											<ant dir="portal-kernel" inheritAll="false" target="test-class">
												<property name="test.class" value="PortalLogAssertorTest" />
											</ant>
										</then>
									</if>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<antcall target="record-test-generated-properties" />

					<if>
						<and>
							<or>
								<matches pattern="(file|https?)://" string="@{test.portal.bundle.war.url}" />
								<matches pattern="(file|https?)://" string="@{test.portal.bundle.zip.url}" />
							</or>
							<matches pattern="(file|https?)://" string="@{test.sql.zip.url}" />
						</and>
						<then>
							<prepare-release-test-environment
								app.server.type="${app.server.type}"
								setup.testable.jboss="@{setup.testable.jboss}"
								setup.testable.tomcat="@{setup.testable.tomcat}"
								test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
								test.fix.pack.base.url="${test.fix.pack.base.url}"
								test.license.xml.url="${test.license.xml.url}"
								test.plugins.war.zip.url="@{test.plugins.war.zip.url}"
								test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
								test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
								test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
								test.portal.bundle.war.url="${test.portal.bundle.war.url}"
								test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
								test.sql.zip.url="${test.sql.zip.url}"
							/>

							<local name="artifact.version" />

							<property name="artifact.version" value="1.0.0-TEST_ARTIFACT" />

							<propertycopy from="app.server.${app.server.type}.lib.global.dir" name="test.app.server.lib.global.dir" />
							<propertycopy from="app.server.${app.server.type}.lib.portal.dir" name="test.app.server.lib.portal.dir" />

							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/portal-impl.jar" artifact.name="com.liferay.portal.impl" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.global.dir}/portal-kernel.jar" artifact.name="com.liferay.portal.kernel" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/util-bridges.jar" artifact.name="com.liferay.util.bridges" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/util-java.jar" artifact.name="com.liferay.util.java" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/util-taglib.jar" artifact.name="com.liferay.util.taglib" artifact.version="${artifact.version}" />
						</then>
						<elseif>
							<and>
								<available file="liferay-portal-bundle-${app.server.type}.tar.gz" />
								<available file="liferay-portal-source.tar.gz" />
							</and>
							<then>
								<prepare-test-environment
									app.server.type="${app.server.type}"
									setup.testable.tomcat="@{setup.testable.tomcat}"
								/>
							</then>
						</elseif>
						<else>
							<antcall target="compile" />

							<if>
								<or>
									<equals arg1="@{app.server.type}" arg2="weblogic" />
									<equals arg1="@{app.server.type}" arg2="websphere" />
								</or>
								<then>
									<prepare-test-build-custom />
								</then>
								<else>
									<ant antfile="build-dist.xml" target="build-dist-${app.server.type}" />
								</else>
							</if>

							<if>
								<and>
									<equals arg1="@{app.server.type}" arg2="jboss" />
									<equals arg1="@{setup.testable.jboss}" arg2="true" />
								</and>
								<then>
									<setup-testable-jboss />
								</then>
								<elseif>
									<and>
										<equals arg1="@{app.server.type}" arg2="tomcat" />
										<equals arg1="@{setup.testable.tomcat}" arg2="true" />
									</and>
									<then>
										<setup-test-batch-testable-tomcat setup.proxy="@{setup.proxy}" />
									</then>
								</elseif>
							</if>
						</else>
					</if>

					<if>
						<matches pattern="https?://" string="@{test.plugin.zip.url}" />
						<then>
							<mkdir dir="${liferay.home}/deploy" />

							<mirrors-get
								dest="${liferay.home}/deploy"
								src="@{test.plugin.zip.url}"
							/>
						</then>
					</if>

					<if>
						<isset property="env.CI_TEST_SUITE" />
						<then>
							<get-testcase-property property.name="osgi.app.includes" />

							<if>
								<not>
									<contains string="${osgi.app.includes}" substring="portal-search-solr7" />
								</not>
								<then>
									<prepare-suite-search-engine suite.name="${env.CI_TEST_SUITE}" />
								</then>
							</if>
						</then>
					</if>

					<echo if:set="env.JENKINS_HOME">ANT_OPTS=${env.ANT_OPTS}</echo>
				</test-set-up>

				<test-tear-down>
					<if>
						<available file=".testable.portal.started" />
						<then>
							<antcall target="stop-app-server" />

							<delete failonerror="false" file=".testable.portal.started" />
						</then>
					</if>
				</test-tear-down>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-legacy-database-dump">
		<attribute name="database.type" />
		<attribute default="" name="database.version" />

		<sequential>
			<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

			<run-functional-test
				app.server.type="tomcat"
				database.type="@{database.type}"
				database.version="@{database.version}"
				setup.testable.jboss="false"
				test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
				test.fix.pack.base.url="${test.fix.pack.base.url}"
				test.legacy.database.dump="true"
				test.license.xml.url="${test.license.xml.url}"
				test.plugins.war.zip.url="${test.plugins.war.zip.url}"
				test.portal.bundle.version="${test.portal.bundle.version}"
				test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
				test.sql.zip.url="${test.sql.zip.url}"
			/>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-base-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="setup-profile-dxp" />

							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-system-ext-properties" />

							<ant dir="modules" inheritAll="false" target="build-app-lpkg-base" />

							<delete dir="${liferay.home}/osgi/deploy" />
							<delete dir="${liferay.home}/osgi/modules" />
							<delete dir="${liferay.home}/osgi/portal" />
							<delete dir="${liferay.home}/osgi/static" />
							<delete dir="${liferay.home}/osgi/war" />

							<delete>
								<fileset
									dir="${liferay.home}/osgi/test"
									excludes="com.liferay.arquillian.extension.junit.bridge.connector.jar,com.liferay.portal.test.jar,com.liferay.portal.test.integration.jar"
								/>
							</delete>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGDeployerCleanStartupTest" />
									</gradle-execute>

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.class" value="PortalSmoke#Smoke" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-container-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<echo file="${app.server.classes.portal.dir}/system-ext.properties">log.sanitizer.enabled=false

com.liferay.portal.kernel.util.ServiceProxyFactory.timeout=300000</echo>

							<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.LPKGContainerTest" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGContainerVerifyTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-controller-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<setup-lpkg-test database.type="@{database.type}" />

							<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.LPKGControllerTest" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGControllerVerifyTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-independence-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="setup-profile-dxp" />

							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-system-ext-properties" />

							<ant dir="modules" inheritAll="false" target="build-app-lpkg-base" />

							<for param="app.dir">
								<path>
									<dirset
										dir="modules"
									>
										<include name="apps/*" />
										<include name="dxp/apps/*" />
										<include name="private/apps/*" />
										<exclude name="${build.exclude.dirs}" />
										<exclude name="apps/static" />
										<exclude name="apps/sync" />
										<present targetdir="modules">
											<mapper
												from="*"
												to="*/app.bnd"
												type="glob"
											/>
										</present>
									</dirset>
								</path>

								<sequential>
									<local name="app.name" />
									<local name="app.suite" />
									<local name="Liferay-Releng-Bundle" />
									<local name="Liferay-Releng-Suite" />

									<basename file="@{app.dir}" property="app.name" />

									<property file="@{app.dir}/app.bnd" />

									<condition else="${app.name}" property="app.suite" value="${Liferay-Releng-Suite}">
										<isset property="Liferay-Releng-Suite" />
									</condition>

									<if>
										<and>
											<equals arg1="${Liferay-Releng-Bundle}" arg2="true" />
											<not>
												<or>
													<equals arg1="${app.suite}" arg2="collaboration" />
													<equals arg1="${app.suite}" arg2="forms-and-workflow" />
													<equals arg1="${app.suite}" arg2="foundation" />
													<equals arg1="${app.suite}" arg2="web-experience" />
												</or>
											</not>
										</and>
										<then>
											<ant dir="modules" inheritAll="false" target="build-app-lpkg">
												<property name="app.name" value="${app.name}" />
												<property name="output.dir" value="${app.server.parent.dir}/osgi/temp/${app.name}" />
											</ant>
										</then>
									</if>
								</sequential>
							</for>

							<delete dir="${liferay.home}/osgi/deploy" />
							<delete dir="${liferay.home}/osgi/modules" />
							<delete dir="${liferay.home}/osgi/portal" />
							<delete dir="${liferay.home}/osgi/static" />
							<delete dir="${liferay.home}/osgi/war" />

							<delete>
								<fileset
									dir="${liferay.home}/osgi/test"
									excludes="com.liferay.arquillian.extension.junit.bridge.connector.jar,com.liferay.portal.test.jar,com.liferay.portal.test.integration.jar"
								/>
							</delete>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGIndependenceTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-override-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<setup-lpkg-test database.type="@{database.type}" />

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.LPKGOverrideTest" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGOverrideVerifySecondStartupTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGOverrideVerifyCleanStartupTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete includeemptydirs="false">
								<fileset
									dir="${liferay.home}/osgi/marketplace/override"
								/>
								<fileset
									dir="${liferay.home}/osgi/static"
								/>
							</delete>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGRevertOverrideVerifyTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-persistence-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<echo file="${app.server.classes.portal.dir}/system-ext.properties">com.liferay.portal.kernel.util.ServiceProxyFactory.timeout=300000
log.sanitizer.enabled=false</echo>

							<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.LPKGPersistenceTest" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGPersistenceStopBundleTest" />
									</gradle-execute>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGPersistenceVerifyTest" />
									</gradle-execute>

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGPersistenceStartBundleTest" />
									</gradle-execute>
								</try>
								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.LPKGPersistenceUpgradeTest" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGPersistenceVerifyUpgradeTest" />
									</gradle-execute>
								</try>
								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-release-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="setup-profile-dxp" />

							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-system-ext-properties" />

							<ant dir="modules" inheritAll="false" target="build-app-lpkg-release" />

							<delete dir="${liferay.home}/osgi/deploy" />
							<delete dir="${liferay.home}/osgi/modules" />
							<delete dir="${liferay.home}/osgi/portal" />
							<delete dir="${liferay.home}/osgi/static" />
							<delete dir="${liferay.home}/osgi/war" />

							<delete>
								<fileset
									dir="${liferay.home}/osgi/test"
									excludes="com.liferay.arquillian.extension.junit.bridge.connector.jar,com.liferay.portal.test.jar,com.liferay.portal.test.integration.jar"
								/>
							</delete>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGDeployerCleanStartupTest" />
									</gradle-execute>

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.class" value="PortalSmoke#Smoke" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-lpkg-startup-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<setup-lpkg-test database.type="@{database.type}" />

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGDeployerCleanStartupTest" />
									</gradle-execute>

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.batch.run.type" value="single" />
										<param name="test.class" value="PortalSmoke#Smoke" />
										<param name="test.skip.tear.down" value="false" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.LPKGUpgradeTest" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGDeployerUpgradeTest" />
									</gradle-execute>

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
										<arg value="test" />
										<arg value="--tests" />
										<arg value="*.LPKGVersionChangeLogAssertorTest" />
										<arg value="-Dliferay.home=${liferay.home}" />
									</gradle-execute>

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.batch.run.type" value="single" />
										<param name="test.class" value="PortalSmoke#Smoke" />
										<param name="test.skip.tear.down" value="false" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
								<arg value="test" />
								<arg value="--tests" />
								<arg value="*.LPKGDowngradeTest" />
								<arg value="-Dliferay.home=${liferay.home}" />
							</gradle-execute>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="testIntegration">
										<arg value="testIntegration" />
										<arg value="--tests" />
										<arg value="*.LPKGDeployerDowngradeTest" />
									</gradle-execute>

									<gradle-execute dir="modules/apps/static/portal-lpkg-deployer/portal-lpkg-deployer-test" task="test">
										<arg value="test" />
										<arg value="--tests" />
										<arg value="*.LPKGVersionChangeLogAssertorTest" />
										<arg value="-Dliferay.home=${liferay.home}" />
									</gradle-execute>

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.batch.run.type" value="single" />
										<param name="test.class" value="PortalSmoke#Smoke" />
										<param name="test.skip.tear.down" value="false" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-modules-integration-test">
		<attribute default="tomcat" name="app.server.type" />
		<attribute name="database.type" />
		<attribute default="${database.@{database.type}.version}" name="database.version" />
		<attribute default="" name="refreshdependencies" />
		<attribute default="true" name="setup.testable.tomcat" />
		<attribute default="" name="subrepository.name" />
		<attribute default="" name="test.build.fix.pack.zip.url" />
		<attribute default="" name="test.fix.pack.base.url" />
		<attribute default="" name="test.license.xml.url" />
		<attribute default="" name="test.portal.bundle.dependencies.zip.url" />
		<attribute default="" name="test.portal.bundle.osgi.zip.url" />
		<attribute default="" name="test.portal.bundle.tools.zip.url" />
		<attribute default="" name="test.portal.bundle.version" />
		<attribute default="" name="test.portal.bundle.war.url" />
		<attribute default="" name="test.portal.bundle.zip.url" />
		<attribute default="" name="test.sql.zip.url" />

		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="@{database.type}" database.version="@{database.version}" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-system-ext-properties" />

							<print-test-class-group test.class.group.index="${axis.variable}" />

							<echo>Executing Gradle task in directory "modules": testIntegration.</echo>

							<setup-test-batch-testable-tomcat test.portal.bundle.version="@{test.portal.bundle.version}" />

							<antcall target="start-app-server-preserve-liferay-home" />

							<gradle-execute dir="modules" refreshdependencies="@{refreshdependencies}" task="testIntegration">
								<arg value="--continue" />
								<arg value="-Dbuild.exclude.ant.plugin=true" />
								<arg value="-Dtest.class.group.index=${axis.variable}" />
							</gradle-execute>

							<antcall target="stop-app-server" />

							<if>
								<and>
									<available file="${app.server.parent.dir}/logs" />
									<available file="${app.server.parent.dir}/osgi/state" />
								</and>
								<then>
									<if>
										<and>
											<or>
												<matches pattern="https?://" string="@{test.portal.bundle.war.url}" />
												<matches pattern="https?://" string="@{test.portal.bundle.zip.url}" />
											</or>
											<matches pattern="https?://" string="@{test.sql.zip.url}" />
										</and>
										<then>
											<gradle-execute dir="modules/core" task="deploy">
												<arg value="--parallel" />
												<arg value="-Dbuild.profile=portal-pre" />
												<arg value="-Pforced.deploy.dir=${project.dir}/tmp/lib-pre" />
											</gradle-execute>

											<ant dir="portal-kernel" inheritAll="false" target="compile" />

											<ant dir="portal-test" inheritAll="false" target="compile" />
										</then>
									</if>

									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</then>
							</if>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<if>
						<and>
							<or>
								<matches pattern="(file|https?)://" string="@{test.portal.bundle.war.url}" />
								<matches pattern="(file|https?)://" string="@{test.portal.bundle.zip.url}" />
							</or>
							<matches pattern="(file|https?)://" string="@{test.sql.zip.url}" />
						</and>
						<then>
							<prepare-release-test-environment
								app.server.type="${app.server.type}"
								setup.testable.tomcat="@{setup.testable.tomcat}"
								test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
								test.fix.pack.base.url="${test.fix.pack.base.url}"
								test.license.xml.url="${test.license.xml.url}"
								test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
								test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
								test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
								test.portal.bundle.war.url="${test.portal.bundle.war.url}"
								test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
								test.sql.zip.url="${test.sql.zip.url}"
							/>

							<gradle-execute dir="modules/core" task="deploy">
								<arg value="--parallel" />
								<arg value="-Dbuild.profile=portal-pre" />
								<arg value="-Pforced.deploy.dir=${project.dir}/tmp/lib-pre" />
							</gradle-execute>

							<ant dir="portal-kernel" inheritAll="false" target="install-portal-snapshot" />

							<gradle-execute dir="modules/apps" task="deploy">
								<arg value="--parallel" />
								<arg value="-Dbuild.profile=portal-pre" />
								<arg value="-Pforced.deploy.dir=${project.dir}/tmp/lib-pre" />
							</gradle-execute>

							<parallel failonany="true" threadcount="${parallel.thread.count}">
								<ant dir="portal-test" inheritAll="false" target="jar" />
								<ant dir="support-tomcat" inheritAll="false" target="compile" />
								<ant dir="util-bridges" inheritAll="false" target="compile" />

								<sequential>
									<ant dir="util-java" inheritAll="false" target="compile" />
									<ant dir="util-taglib" inheritAll="false" target="compile" />
								</sequential>

								<ant dir="util-slf4j" inheritAll="false" target="compile" />
							</parallel>

							<ant dir="portal-impl" inheritAll="false" target="compile" />

							<ant dir="portal-test-integration" inheritAll="false" target="jar" />

							<copy
								file="${project.dir}/portal-test/portal-test.jar"
								overwrite="true"
								tofile="${liferay.home}/osgi/modules/com.liferay.portal.test.jar"
							/>

							<copy
								file="${project.dir}/portal-test/portal-test.jar"
								overwrite="true"
								tofile="${liferay.home}/osgi/test/com.liferay.portal.test.jar"
							/>

							<copy
								file="${project.dir}/portal-test-integration/portal-test-integration.jar"
								overwrite="true"
								tofile="${liferay.home}/osgi/modules/com.liferay.portal.test.integration.jar"
							/>

							<copy
								file="${project.dir}/portal-test-integration/portal-test-integration.jar"
								overwrite="true"
								tofile="${liferay.home}/osgi/test/com.liferay.portal.test.integration.jar"
							/>

							<gradle-execute dir="modules/apps/static/required-dependencies/required-dependencies" task="deployReqTestLibs" />

							<local name="artifact.version" />

							<property name="artifact.version" value="1.0.0-TEST_ARTIFACT" />

							<propertycopy from="app.server.${app.server.type}.lib.global.dir" name="test.app.server.lib.global.dir" />
							<propertycopy from="app.server.${app.server.type}.lib.portal.dir" name="test.app.server.lib.portal.dir" />

							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/portal-impl.jar" artifact.name="com.liferay.portal.impl" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.global.dir}/portal-kernel.jar" artifact.name="com.liferay.portal.kernel" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${liferay.home}/osgi/test/com.liferay.arquillian.extension.junit.bridge.connector.jar" artifact.name="com.liferay.arquillian.extension.junit.bridge.connector" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${liferay.home}/osgi/test/com.liferay.portal.test.jar" artifact.name="com.liferay.portal.test" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${liferay.home}/osgi/test/com.liferay.portal.test.integration.jar" artifact.name="com.liferay.portal.test.integration" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/util-bridges.jar" artifact.name="com.liferay.util.bridges" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/util-java.jar" artifact.name="com.liferay.util.java" artifact.version="${artifact.version}" />
							<copy-artifact-to-local-cache artifact.file="${test.app.server.lib.portal.dir}/util-taglib.jar" artifact.name="com.liferay.util.taglib" artifact.version="${artifact.version}" />

							<deploy-release-dependency-modules />
						</then>
						<elseif>
							<and>
								<available file="liferay-portal-bundle-${app.server.type}.tar.gz" />
								<available file="liferay-portal-source.tar.gz" />
							</and>
							<then>
								<prepare-test-environment setup.testable.tomcat="@{setup.testable.tomcat}" />
							</then>
						</elseif>
						<else>
							<prepare-test-build />
						</else>
					</if>

					<if>
						<isset property="env.CI_TEST_SUITE" />
						<then>
							<prepare-suite-search-engine suite.name="${env.CI_TEST_SUITE}" />
						</then>
					</if>

					<antcall inheritAll="false" target="record-test-class-file-names">
						<param name="test.class.groups.size" value="${test.batch.size}" />
					</antcall>
				</test-set-up>

				<test-tear-down>
					<stop-suite-search-engine />
				</test-tear-down>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-poshi-validation">
		<sequential>
			<antcall target="run-poshi-validation" />
		</sequential>
	</macrodef>

	<macrodef name="run-release-osgi-state-exploded-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<antcall inheritAll="false" target="prepare-log4j-ext-xml">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
							</antcall>

							<echo file="${app.server.classes.portal.dir}/system-ext.properties">com.liferay.portal.kernel.util.ServiceProxyFactory.timeout=300000
log.sanitizer.enabled=false</echo>

							<antcall inheritall="false" target="start-app-server" />

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<delete>
								<fileset
									dir="${liferay.home}/osgi/state"
									includes="**/bundleFile"
								/>
							</delete>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.batch.run.type" value="single" />
										<param name="test.class" value="PortalSmoke#Smoke" />
										<param name="test.skip.tear.down" value="false" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-release-osgi-state-lpkg-change-directory-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<setup-lpkg-test database.type="@{database.type}" />

							<antcall inheritall="false" target="start-app-server" />

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<delete>
								<fileset
									dir="${liferay.home}/osgi/state"
									includes="**/bundleFile"
								/>
							</delete>

							<antcall inheritAll="false" target="prepare-portal-ext-properties">
								<param name="database.type" value="@{database.type}" />
								<param name="liferay.home" value="${project.dir}/bun dles" />
							</antcall>

							<antcall inheritAll="false" target="prepare-system-ext-properties" />

							<move
								file="bundles"
								tofile="bun dles"
							/>

							<propertyfile file="app.server.${env.HOSTNAME}.properties">
								<entry key="app.server.parent.dir" value="${project.dir}/bun dles" />
							</propertyfile>

							<propertyfile file="build.${env.HOSTNAME}.properties">
								<entry key="liferay.home" value="${project.dir}/bun dles" />
							</propertyfile>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.batch.run.type" value="single" />
										<param name="test.class" value="PortalSmoke#Smoke" />
										<param name="test.skip.tear.down" value="false" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="run-release-osgi-state-lpkg-test">
		<sequential>
			<run-batch-test tomcat.gc.log="true">
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<setup-lpkg-test database.type="@{database.type}" />

							<antcall inheritall="false" target="start-app-server" />

							<antcall inheritall="false" target="stop-app-server" />

							<delete dir="${liferay.home}/logs" />

							<delete>
								<fileset
									dir="${liferay.home}/osgi/state"
									includes="**/bundleFile"
								/>
							</delete>

							<trycatch>
								<try>
									<antcall inheritall="false" target="start-app-server-preserve-liferay-home" />

									<antcall inheritall="false" target="run-selenium-test">
										<param name="test.batch.run.type" value="single" />
										<param name="test.class" value="PortalSmoke#Smoke" />
										<param name="test.skip.tear.down" value="false" />
									</antcall>
								</try>

								<finally>
									<ant dir="portal-kernel" inheritAll="false" target="test-class">
										<property name="test.class" value="PortalLogAssertorTest" />
									</ant>
								</finally>
							</trycatch>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</macrodef>

	<macrodef name="setup-lpkg-test">
		<attribute name="database.type" />

		<sequential>
			<antcall inheritAll="false" target="setup-profile-dxp" />

			<antcall inheritAll="false" target="prepare-log4j-ext-xml">
				<param name="database.type" value="@{database.type}" />
			</antcall>

			<antcall inheritAll="false" target="prepare-portal-ext-properties">
				<param name="database.type" value="@{database.type}" />
			</antcall>

			<echo file="${app.server.classes.portal.dir}/system-ext.properties">com.liferay.portal.kernel.util.ServiceProxyFactory.timeout=300000
log.sanitizer.enabled=false</echo>

			<ant dir="modules" inheritAll="false" target="build-app-lpkg-all">
				<property name="app.server.parent.dir" value="${project.dir}/bundles" />
				<property name="osgi.dir" value="${app.server.parent.dir}/osgi" />
			</ant>
		</sequential>
	</macrodef>

	<macrodef name="setup-test-batch-testable-tomcat">
		<attribute default="true" name="setup.proxy" />
		<attribute default="" name="test.portal.bundle.version" />

		<sequential>
			<if>
				<equals arg1="@{setup.proxy}" arg2="true" />
				<then>
					<setup-testable-tomcat-dummy-socket-proxy />
				</then>
			</if>

			<setup-testable-tomcat-gc test.portal.bundle.version="@{test.portal.bundle.version}" />

			<setup-testable-tomcat-heap-dump-on-oom />

			<setup-testable-tomcat-print-final-flags />

			<setup-testable-tomcat />
		</sequential>
	</macrodef>

	<macrodef name="setup-test-environment">
		<sequential>
			<if>
				<and>
					<available file="liferay-portal-bundle-${app.server.type}.tar.gz" />
					<available file="liferay-portal-source.tar.gz" />
				</and>
				<then>
					<prepare-test-environment />
				</then>
				<else>
					<prepare-test-build />
				</else>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="setup-testable-tomcat-dummy-socket-proxy">
		<sequential>
			<get-database-socks-non-proxy-hosts />

			<if>
				<not>
					<resourcecontains
						resource="${app.server.tomcat.dir}/bin/setenv.bat"
						substring="${dummy.socket.proxy}"
					/>
				</not>
				<then>
					<echo append="true" file="${app.server.tomcat.dir}/bin/setenv.bat">
						<![CDATA[
							set "CATALINA_OPTS=%CATALINA_OPTS% ${dummy.socket.proxy} ${database.socks.non.proxy.hosts}"
						]]>
					</echo>
				</then>
			</if>

			<if>
				<not>
					<resourcecontains
						resource="${app.server.tomcat.dir}/bin/setenv.sh"
						substring="${dummy.socket.proxy}"
					/>
				</not>
				<then>
					<echo append="true" file="${app.server.tomcat.dir}/bin/setenv.sh">
						<![CDATA[
							CATALINA_OPTS="${CATALINA_OPTS} ${dummy.socket.proxy} ${database.socks.non.proxy.hosts}"
						]]>
					</echo>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="setup-testable-tomcat-gc">
		<attribute default="" name="test.portal.bundle.version" />

		<sequential>
			<if>
				<os family="windows" />
				<then>
					<var name="set.env.file.name" value="${app.server.tomcat.bin.dir}/setenv.bat" />
				</then>
				<else>
					<var name="set.env.file.name" value="${app.server.tomcat.bin.dir}/setenv.sh" />
				</else>
			</if>

			<if>
				<not>
					<equals arg1="@{test.portal.bundle.version}" arg2="" />
				</not>
				<then>
					<copy
						file="tools/servers/tomcat/bin/setenv.bat"
						overwrite="true"
						tofile="${app.server.tomcat.bin.dir}/setenv.bat"
					/>

					<copy
						file="tools/servers/tomcat/bin/setenv.sh"
						overwrite="true"
						tofile="${app.server.tomcat.bin.dir}/setenv.sh"
					/>

					<chmod
						perm="a+x"
					>
						<fileset
							dir="${app.server.tomcat.bin.dir}"
						>
							<include name="*.sh" />
						</fileset>
					</chmod>
				</then>
			</if>

			<get-java-jdk-bundle-version test.batch.name="${test.batch.name}" />

			<if>
				<isset property="test.batch.app.server.tomcat.setenv.gc.new[${java.jdk.bundle.version}]" />
				<then>
					<propertycopy from="test.batch.app.server.tomcat.setenv.gc.new[${java.jdk.bundle.version}]" name="test.batch.app.server.tomcat.setenv.gc.new" override="true" />
				</then>
			</if>

			<if>
				<resourcecontains
					resource="${set.env.file.name}"
					substring="${test.batch.app.server.tomcat.setenv.gc.old}"
				/>
				<then>
					<replace
						file="${set.env.file.name}"
						token="${test.batch.app.server.tomcat.setenv.gc.old}"
						value="${test.batch.app.server.tomcat.setenv.gc.new}"
					/>
				</then>
				<else>
					<if>
						<not>
							<resourcecontains
								resource="${set.env.file.name}"
								substring="${test.batch.app.server.tomcat.setenv.gc.new}"
							/>
						</not>
						<then>
							<fail message="Unable to setup Tomcat GC properties for ${set.env.file.name}" />
						</then>
					</if>
				</else>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="setup-testable-tomcat-heap-dump-on-oom">
		<sequential>
			<local name="heap.dump.on.oom" />

			<property name="heap.dump.on.oom" value="-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=${test.batch.app.server.tomcat.setenv.heap.dump.path}" />

			<if>
				<not>
					<resourcecontains
						resource="${app.server.tomcat.dir}/bin/setenv.bat"
						substring="${heap.dump.on.oom}"
					/>
				</not>
				<then>
					<echo append="true" file="${app.server.tomcat.dir}/bin/setenv.bat">
						<![CDATA[
							set "CATALINA_OPTS=%CATALINA_OPTS% ${heap.dump.on.oom}"
						]]>
					</echo>
				</then>
			</if>
			<if>
				<not>
					<resourcecontains
						resource="${app.server.tomcat.dir}/bin/setenv.sh"
						substring="${heap.dump.on.oom}"
					/>
				</not>
				<then>
					<echo append="true" file="${app.server.tomcat.dir}/bin/setenv.sh">
						<![CDATA[
							CATALINA_OPTS="${CATALINA_OPTS} ${heap.dump.on.oom}"
						]]>
					</echo>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="setup-testable-tomcat-print-final-flags">
		<sequential>
			<local name="print.final.flags" />

			<property name="print.final.flags" value="-XX:+PrintFlagsFinal" />

			<if>
				<not>
					<resourcecontains
						resource="${app.server.tomcat.dir}/bin/setenv.bat"
						substring="${print.final.flags}"
					/>
				</not>
				<then>
					<echo append="true" file="${app.server.tomcat.dir}/bin/setenv.bat">
						<![CDATA[
							set "CATALINA_OPTS=%CATALINA_OPTS% ${print.final.flags}"
						]]>
					</echo>
				</then>
			</if>
			<if>
				<not>
					<resourcecontains
						resource="${app.server.tomcat.dir}/bin/setenv.sh"
						substring="${print.final.flags}"
					/>
				</not>
				<then>
					<echo append="true" file="${app.server.tomcat.dir}/bin/setenv.sh">
						<![CDATA[
							CATALINA_OPTS="${CATALINA_OPTS} ${print.final.flags}"
						]]>
					</echo>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="start-docker-database">
		<sequential>
			<get-database-property property.name="database.host" />
			<get-database-property property.name="database.docker.image" />
			<get-database-property property.name="database.docker.run.options" />

			<local name="database.docker.network.run.option" />

			<condition else="" property="database.docker.network.run.option" value="--network=${env.DOCKER_NETWORK_NAME}">
				<isset property="env.DOCKER_NETWORK_NAME" />
			</condition>

			<local name="docker.start.script" />

			<property name="docker.start.script" value="docker_start.sh" />

			<echo file="${docker.start.script}">
				<![CDATA[
					docker run \
						--detach \
						--hostname=${database.host} \
						--interactive \
						--name=${database.host} \
						--tty \
						\
						${database.docker.network.run.option} \
						${database.docker.run.options} \
						\
						${database.docker.image}
				]]>
			</echo>

			<chmod
				perm="a+x"
			>
				<fileset
					dir="."
					includes="${docker.start.script}"
				/>
			</chmod>

			<exec executable="/bin/bash" os="${os.apple},${os.unix}">
				<arg value="${docker.start.script}" />
			</exec>

			<exec executable="cmd.exe" os="${os.windows}">
				<arg value="${docker.start.script}" />
			</exec>

			<delete file="${docker.start.script}" />

			<if>
				<or>
					<equals arg1="${database.type}" arg2="mariadb" />
					<equals arg1="${database.type}" arg2="mysql" />
				</or>
				<then>
					<property location="${project.dir}/setup.sh" name="setup.sh.file" />

					<local name="database.name" />

					<condition else="MariaDB" property="database.name" value="MySQL">
						<equals arg1="${database.type}" arg2="mysql" />
					</condition>

					<get-database-property property.name="database.version" />

					<echo file="${setup.sh.file}">
						<![CDATA[
							#!/bin/bash

							while ! mysqladmin ping --host=localhost --silent
							do
								echo "Waiting for ${database.name} ${database.version} to be ready"

								sleep 10
							done
						]]>
					</echo>

					<get-database-property property.name="database.host" />

					<execute failonerror="false">
						<![CDATA[
							docker cp ${setup.sh.file} ${database.host}:/tmp/setup.sh

							docker exec ${database.host} /bin/bash /tmp/setup.sh
						]]>
					</execute>
				</then>
				<elseif>
					<equals arg1="${database.type}" arg2="oracle" />
					<then>
						<property location="${project.dir}/setup.sh" name="setup.sh.file" />

						<get-database-property property.name="database.version" />

						<echo file="${setup.sh.file}">
							<![CDATA[
								#!/bin/bash

								sqlplus ${oracle.admin.user}/${oracle.admin.password} @/tmp/setup.sql

								while [[ "$(${ORACLE_HOME}/bin/lsnrctl status | grep READY)" == "" ]]
								do
									echo "Waiting for Oracle ${database.version} to be ready"

									sleep 10
								done

								${ORACLE_HOME}/bin/lsnrctl status
							]]>
						</echo>

						<property location="${project.dir}/setup.sql" name="setup.sql.file" />

						<echo file="${setup.sql.file}">
							<![CDATA[
								alter system set result_cache_max_size=24M scope=spfile;
								alter system set sga_target=4928M scope=spfile;
								alter system set shared_pool_reserved_size=40M scope=spfile;

								quit;
							]]>
						</echo>

						<get-database-property property.name="database.host" />

						<execute failonerror="false">
							<![CDATA[
								docker cp ${setup.sh.file} ${database.host}:/tmp/setup.sh
								docker cp ${setup.sql.file} ${database.host}:/tmp/setup.sql

								docker exec ${database.host} /bin/bash /tmp/setup.sh
							]]>
						</execute>
					</then>
				</elseif>
				<elseif>
					<equals arg1="${database.type}" arg2="postgresql" />
					<then>
						<property location="setup.sh" name="setup.sh.file" />

						<get-database-property property.name="database.version" />

						<echo file="${setup.sh.file}">
							<![CDATA[
								#!/bin/bash

								while [[ "$(pg_isready | grep 'accepting connections')" == "" ]]
								do
									echo "Waiting for PostgreSQL ${database.version} to be ready"

									sleep 10
								done

								pg_isready
							]]>
						</echo>

						<get-database-property property.name="database.host" />

						<execute failonerror="false">
							<![CDATA[
								docker cp ${setup.sh.file} ${database.host}:/tmp/setup.sh

								docker exec ${database.host} /bin/bash /tmp/setup.sh
							]]>
						</execute>
					</then>
				</elseif>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="stop-docker-database">
		<sequential>
			<get-database-property property.name="database.host" />

			<local name="docker.stop.script" />

			<property name="docker.stop.script" value="docker_stop.sh" />

			<echo file="${docker.stop.script}">
				<![CDATA[
					docker_kill_list=$(docker ps -a -q --filter="name=${database.host}")

					if [[ "${docker_kill_list}" != "" ]]
					then
						docker kill ${docker_kill_list}
					fi

					docker_rm_list=$(docker ps -q -f "status=exited")

					if [[ "${docker_rm_list}" != "" ]]
					then
						docker rm ${docker_rm_list}
					fi
				]]>
			</echo>

			<chmod
				perm="a+x"
			>
				<fileset
					dir="."
					includes="${docker.stop.script}"
				/>
			</chmod>

			<exec executable="/bin/bash" failonerror="false" os="${os.apple},${os.unix}">
				<arg value="${docker.stop.script}" />
			</exec>

			<exec executable="cmd.exe" failonerror="false" os="${os.windows}">
				<arg value="${docker.stop.script}" />
			</exec>

			<delete file="${docker.stop.script}" />
		</sequential>
	</macrodef>

	<macrodef name="stop-suite-search-engine">
		<sequential>
			<if>
				<equals arg1="${suite.search.engine}" arg2="solr" />
				<then>
					<ant antfile="build-test-solr.xml" target="stop-solr-core" />
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="wait-for-app-server-log-message">
		<attribute name="log.message" />

		<sequential>
			<local name="timed.out.message" />

			<beanshell>
				<![CDATA[
					import java.io.File;

					import org.apache.commons.io.FileUtils;

					import org.apache.tools.ant.DirectoryScanner;

					public boolean isContainedInCatalinaLogFiles(String searchString) {
						DirectoryScanner directoryScanner = new DirectoryScanner();

						File liferayHomeDir = new File(project.getProperty("liferay.home"));

						String canonicalLogFileLocation = liferayHomeDir.getCanonicalPath();

						directoryScanner.setIncludes(new String[] {canonicalLogFileLocation + "/logs/liferay.*.log"});

						directoryScanner.scan();

						String osName = project.getProperty("os.name");

						osName = osName.toLowerCase();

						for (String filePath : directoryScanner.getIncludedFiles()) {
							if (osName.contains("win")) {
								filePath = filePath.replace("/", "\\");
							}

							File file = new File(filePath);

							String fileContent = FileUtils.readFileToString(file);

							if (fileContent.contains(searchString)) {
								return true;
							}
						}

						return false;
					}

					System.out.println("Waiting for '@{log.message}' to appear in log message");

					int timeoutDuration = Integer.parseInt(project.getProperty("timeout.app.server.wait"));

					long timeoutTime = System.currentTimeMillis() + (1000 * timeoutDuration);

					while (true) {
						try {
							if (isContainedInCatalinaLogFiles("@{log.message}")) {
								break;
							}
						}
						catch (Exception e) {
							e.printStackTrace();
						}

						long currentTime = System.currentTimeMillis();

						if (currentTime > timeoutTime) {
							project.setProperty("timed.out.message", "Unable to find log message after " + (timeoutDuration / 60) + " minutes.");

							break;
						}

						Thread.sleep(1000);
					}
				]]>
			</beanshell>

			<if>
				<isset property="timed.out.message" />
				<then>
					<get-jstack-output process.name="Bootstrap" />

					<fail message="${timed.out.message}${line.separator}${jstack.output}" />
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="archived-module-smoke-jdk8">
		<run-archived-module-smoke />
	</target>

	<target name="archived-modules-test-jdk8">
		<run-archived-modules-test />
	</target>

	<target name="blade-samples-jdk8">
		<run-batch-test>
			<test-action>
				<execute dir="${blade.samples.dir}">
					<![CDATA[
						/bin/bash build.sh
					]]>
				</execute>
			</test-action>

			<test-set-up>
				<if>
					<and>
						<matches pattern="https?://" string="${test.build.fix.pack.zip.url}" />
						<matches pattern="https?://" string="${test.portal.bundle.zip.url}" />
					</and>
					<then>
						<antcall target="prepare-test-bundle">
							<param name="test.app.server.bin.dir" value="${app.server.bin.dir}" />
							<param name="test.build.bundle.zip.url" value="${test.portal.bundle.zip.url}" />
							<param name="test.build.fix.pack.zip.url" value="${test.build.fix.pack.zip.url}" />
						</antcall>
					</then>
					<elseif>
						<matches pattern="https?://" string="${test.portal.bundle.zip.url}" />
						<then>
							<antcall target="prepare-test-bundle">
								<param name="test.app.server.bin.dir" value="${app.server.bin.dir}" />
								<param name="test.build.bundle.zip.url" value="${test.portal.bundle.zip.url}" />
							</antcall>
						</then>
					</elseif>
					<elseif>
						<and>
							<available file="liferay-portal-bundle-${app.server.type}.tar.gz" />
							<available file="liferay-portal-source.tar.gz" />
						</and>
						<then>
							<prepare-test-environment />
						</then>
					</elseif>
					<else>
						<antcall target="compile" />

						<ant antfile="build-dist.xml" target="build-dist-tomcat" />
					</else>
				</if>

				<delete file="${app.server.tomcat.classes.portal.dir}/portal-ext.properties" />

				<remake-dir dir="tools/zip_tmpl/license" />

				<ant antfile="build-dist.xml" target="zip-tomcat" />

				<propertyfile file="${blade.samples.dir}/liferay-workspace/gradle.properties">
					<entry key="app.server.tomcat.version" value="${app.server.tomcat.version}" />
					<entry key="liferay.workspace.bundle.url" value="file:///${project.dir}/dist/liferay-portal-tomcat-${lp.version}.zip" />
				</propertyfile>

				<print-file file.name="${blade.samples.dir}/liferay-workspace/gradle.properties" />

				<if>
					<matches pattern="https?://" string="${test.license.xml.url}" />
					<then>
						<mirrors-get
							dest="${blade.samples.dir}/liferay-workspace/configs/common/deploy/license.xml"
							src="${test.license.xml.url}"
						/>
					</then>
				</if>
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="bundle-blacklist-restart-jdk8">
		<run-bundle-blacklist-restart-test />
	</target>

	<target name="central-requirements-jdk8">
		<fail message="Please set the property ${central.requirements.tests}." unless="central.requirements.tests" />

		<run-batch-test>
			<test-action>
				<propertyfile file="${project.dir}/test.class.file.names.properties">
					<entry key="TEST_CLASS_GROUP_0" value="${central.requirements.tests}" />
				</propertyfile>

				<ant dir="portal-kernel" inheritAll="false" target="test-class-group">
					<property name="test.class.group.index" value="0" />
				</ant>

				<ant dir="portal-impl" inheritAll="false" target="test-class-group">
					<property name="test.class.group.index" value="0" />
					<property name="test.type" value="unit" />
				</ant>

				<ant dir="util-java" inheritAll="false" target="test-class-group">
					<property name="test.class.group.index" value="0" />
				</ant>
			</test-action>

			<test-set-up>
				<ant target="compile" />

				<ant target="install-portal-snapshots" />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="compile-jsp-jdk8">
		<run-batch-test>
			<test-action>
				<delete dir="${project.dir}/portal-web/docroot/html" />

				<copy
					todir="${project.dir}/portal-web/docroot/html"
				>
					<fileset
						dir="${app.server.tomcat.dir}/webapps/ROOT/html"
					/>
				</copy>

				<ant dir="portal-web" target="compile-tomcat" />

				<gradle-execute dir="modules" task="compileJSP" />
			</test-action>

			<test-set-up>
				<setup-test-environment />

				<prepare-database-upgrade-configuration />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="database-upgrade-client-jdk8">
		<run-batch-test>
			<test-action>
				<local name="junit.failure.count" />
				<local name="junit.failure.message" />

				<trycatch property="junit.failure.message">
					<try>
						<for keepgoing="true" list="check-upgrade-client-gogoshell,check-upgrade-client-help,check-upgrade-client-java-version,check-upgrade-client-custom-log,check-upgrade-client-additional-settings,check-upgrade-client-sh-disconnect,check-upgrade-client-upgrade-core-only,check-upgrade-client-zip-content,check-upgrade-properties-app-db-set,check-upgrade-properties-app-ext-set,check-upgrade-properties-db-ext-set,check-upgrade-properties-none-set" param="upgrade.test.target">
							<sequential>
								<ant antfile="modules/util/portal-tools-db-upgrade-client/src/testFunctional/ant/build-test-db-upgrade-client.xml" target="@{upgrade.test.target}" />
							</sequential>
						</for>
					</try>
					<finally>
						<condition else="0" property="junit.failure.count" value="1">
							<isset property="junit.failure.message" />
						</condition>

						<get-junit-failure-message-element />

						<generate-backend-batch-junit-report
							junit.failure.count="${junit.failure.count}"
							junit.failure.message.element="${junit.failure.message.element}"
							test.class.name="DatabaseUpgradeClient"
							test.command.name="databaseUpgradeClient"
						/>
					</finally>
				</trycatch>
			</test-action>

			<test-set-up>
				<setup-test-environment />

				<database-test-action database.type="mysql">
					<action>
						<exec executable="${database.service.executable}">
							<arg line="${database.service.cmd.start}" />
						</exec>
					</action>
				</database-test-action>

				<antcall target="rebuild-legacy-database">
					<param name="portal.version" value="6.2.5" />
					<param name="data.archive.type" value="data-archive-polls" />
					<param name="skip.get.testcase.database.properties" value="true" />
				</antcall>

				<prepare-database-upgrade-configuration />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="dist-jdk7">
		<parallel threadCount="1" timeout="7200000">
			<prepare-test-build-dist app.server.type="${axis.variable}" />
		</parallel>
	</target>

	<target name="empty-temp-dir-jdk8">
		<run-empty-temp-dir-test />
	</target>

	<target name="functional-bundle-jboss-db2111-jdk8">
		<run-functional-test
			app.server.type="jboss"
			database.type="db2"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-jboss-mysql56-jdk8">
		<run-functional-test
			app.server.type="jboss"
			database.type="mysql"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-jboss-mysql57-jdk8">
		<run-functional-test
			app.server.type="jboss"
			database.type="mysql"
			database.version="5.7"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-marketplaceapp-smoke-jboss-mysql56-jdk8">
		<antcall target="functional-bundle-jboss-mysql56-jdk8" />
	</target>

	<target name="functional-bundle-marketplaceapp-smoke-jboss-mysql57-jdk8">
		<antcall target="functional-bundle-jboss-mysql57-jdk8" />
	</target>

	<target name="functional-bundle-marketplaceapp-smoke-tomcat-mysql56-jdk8">
		<antcall target="functional-bundle-tomcat-mysql56-jdk8" />
	</target>

	<target name="functional-bundle-marketplaceapp-smoke-tomcat-mysql57-jdk8">
		<antcall target="functional-bundle-tomcat-mysql57-jdk8" />
	</target>

	<target name="functional-bundle-marketplaceapp-smoke-wildfly-mysql56-jdk8">
		<antcall target="functional-bundle-wildfly-mysql56-jdk8" />
	</target>

	<target name="functional-bundle-marketplaceapp-smoke-wildfly-mysql57-jdk8">
		<antcall target="functional-bundle-wildfly-mysql57-jdk8" />
	</target>

	<target name="functional-bundle-tcserver-mysql56-jdk8">
		<run-functional-test
			app.server.type="tcserver"
			database.type="mysql"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tcserver-mysql57-jdk8">
		<run-functional-test
			app.server.type="tcserver"
			database.type="mysql"
			database.version="5.7"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-db2111-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="db2"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-hypersonic20-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="hypersonic"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-mariadb102-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="mariadb"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-mysql56-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="mysql"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-mysql57-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="mysql"
			database.version="5.7"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-mysql57-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="mysql"
			database.version="5.7"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-oracle122-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="oracle"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-oracle193-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="oracle"
			database.version="19.3.0.0.0"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-postgresql10-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="postgresql"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-tomcat-sybase160-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="sybase"
			setup.proxy="false"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-weblogic-mysql56-jdk8">
		<run-functional-test
			app.server.type="weblogic"
			database.type="mysql"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-weblogic-mysql57-jdk8">
		<run-functional-test
			app.server.type="weblogic"
			database.type="mysql"
			database.version="5.7"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-wildfly-mariadb102-jdk8">
		<run-functional-test
			app.server.type="wildfly"
			database.type="mariadb"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-wildfly-mysql56-jdk8">
		<run-functional-test
			app.server.type="wildfly"
			database.type="mysql"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-bundle-wildfly-mysql57-jdk8">
		<run-functional-test
			app.server.type="wildfly"
			database.type="mysql"
			database.version="5.7"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.plugin.zip.url="${test.plugin.zip.url}"
			test.plugins.war.zip.url="${test.plugins.war.zip.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.portal.lpkg.name="${test.portal.lpkg.name}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="functional-smoke-bundle-tomcat-mysql56-jdk8">
		<antcall target="functional-bundle-tomcat-mysql56-jdk8" />
	</target>

	<target name="functional-smoke-bundle-tomcat-mysql57-jdk8">
		<antcall target="functional-bundle-tomcat-mysql57-jdk8" />
	</target>

	<target name="functional-smoke-bundle-tomcat-mysql57-jdk11_open">
		<antcall target="functional-bundle-tomcat-mysql57-jdk11_open" />
	</target>

	<target name="functional-smoke-jboss71-mysql57-jdk8">
		<run-functional-test app.server.type="jboss" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-jboss71-mysql57-jdk11_open">
		<run-functional-test app.server.type="jboss" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tcserver40-mysql57-jdk8">
		<run-functional-test app.server.type="tcserver" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tcserver40-mysql57-jdk11_open">
		<run-functional-test app.server.type="tcserver" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-db2111-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="db2" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-db2111-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="db2" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mariadb102-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mariadb" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mariadb102-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="mariadb" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mysql57-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mysql57-jdk8_redhat">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mysql57-jdk8_zulu">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mysql57-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mysql57-jdk11_oracle">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-mysql57-jdk11_zulu">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-oracle122-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="oracle" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-oracle122-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="oracle" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-oracle193-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="oracle" database.version="19.3.0.0.0" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-oracle193-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="oracle" database.version="19.3.0.0.0" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-postgresql10-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-postgresql10-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-postgresql11-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" database.version="11" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-postgresql11-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" database.version="11" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-sybase160-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="sybase" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-tomcat90-sybase160-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="sybase" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-weblogic122-mysql57-jdk8">
		<run-functional-test app.server.type="weblogic" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-websphere90-mysql57-jdk8">
		<run-functional-test app.server.type="websphere" database.type="mysql" database.version="5.7" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-wildfly160-mariadb102-jdk8">
		<run-functional-test app.server.type="wildfly" database.type="mariadb" test.portal.log.assert="true" />
	</target>

	<target name="functional-smoke-wildfly160-mariadb102-jdk11_open">
		<run-functional-test app.server.type="wildfly" database.type="mariadb" test.portal.log.assert="true" />
	</target>

	<target name="functional-tomcat90-db2111-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="db2" />
	</target>

	<target name="functional-tomcat90-db2111-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="db2" />
	</target>

	<target name="functional-tomcat90-hypersonic20-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="hypersonic" />
	</target>

	<target name="functional-tomcat90-hypersonic20-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="hypersonic" />
	</target>

	<target name="functional-tomcat90-mariadb102-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mariadb" />
	</target>

	<target name="functional-tomcat90-mariadb102-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="mariadb" />
	</target>

	<target name="functional-tomcat90-mysql57-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-tomcat90-mysql57-jdk8-quarantine">
		<antcall target="functional-tomcat90-mysql57-jdk8" />
	</target>

	<target name="functional-tomcat90-mysql57-jdk8_redhat">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-tomcat90-mysql57-jdk8_zulu">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-tomcat90-mysql57-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-tomcat90-mysql57-jdk11_oracle">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-tomcat90-mysql57-jdk11_zulu">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-tomcat90-oracle122-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="oracle" />
	</target>

	<target name="functional-tomcat90-oracle122-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="oracle" />
	</target>

	<target name="functional-tomcat90-oracle193-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="oracle" database.version="19.3.0.0.0" />
	</target>

	<target name="functional-tomcat90-oracle193-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="oracle" database.version="19.3.0.0.0" />
	</target>

	<target name="functional-tomcat90-postgresql10-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" />
	</target>

	<target name="functional-tomcat90-postgresql10-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" />
	</target>

	<target name="functional-tomcat90-postgresql11-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" database.version="11" />
	</target>

	<target name="functional-tomcat90-postgresql11-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" database.version="11" />
	</target>

	<target name="functional-tomcat90-sybase160-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="sybase" />
	</target>

	<target name="functional-tomcat90-sybase160-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="sybase" />
	</target>

	<target name="functional-upgrade-jboss71-mysql57-jdk8">
		<run-functional-test app.server.type="jboss" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-jboss71-mysql57-jdk11_open">
		<run-functional-test app.server.type="jboss" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-tcserver40-mysql57-jdk8">
		<run-functional-test app.server.type="tcserver" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-tcserver40-mysql57-jdk11_open">
		<run-functional-test app.server.type="tcserver" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-tomcat90-db2111-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="db2" />
	</target>

	<target name="functional-upgrade-tomcat90-db2111-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="db2" />
	</target>

	<target name="functional-upgrade-tomcat90-mariadb102-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mariadb" />
	</target>

	<target name="functional-upgrade-tomcat90-mariadb102-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="mariadb" />
	</target>

	<target name="functional-upgrade-tomcat90-mysql57-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-tomcat90-mysql57-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-tomcat90-oracle122-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="oracle" />
	</target>

	<target name="functional-upgrade-tomcat90-oracle122-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="oracle" />
	</target>

	<target name="functional-upgrade-tomcat90-oracle193-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="oracle" database.version="19.3.0.0.0" />
	</target>

	<target name="functional-upgrade-tomcat90-oracle193-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="oracle" database.version="19.3.0.0.0" />
	</target>

	<target name="functional-upgrade-tomcat90-postgresql10-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" />
	</target>

	<target name="functional-upgrade-tomcat90-postgresql10-jdk8-quarantine">
		<antcall target="functional-upgrade-tomcat90-postgresql10-jdk8" />
	</target>

	<target name="functional-upgrade-tomcat90-postgresql10-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" />
	</target>

	<target name="functional-upgrade-tomcat90-postgresql11-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" database.version="11" />
	</target>

	<target name="functional-upgrade-tomcat90-postgresql11-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="postgresql" database.version="11" />
	</target>

	<target name="functional-upgrade-tomcat90-sybase160-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="sybase" />
	</target>

	<target name="functional-upgrade-tomcat90-sybase160-jdk11_open">
		<run-functional-test app.server.type="tomcat" database.type="sybase" />
	</target>

	<target name="functional-upgrade-weblogic121-mysql56-jdk8">
		<run-functional-test app.server.type="weblogic" database.type="mysql" />
	</target>

	<target name="functional-upgrade-weblogic122-mysql57-jdk8">
		<run-functional-test app.server.type="weblogic" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-websphere90-mysql57-jdk8">
		<run-functional-test app.server.type="websphere" database.type="mysql" database.version="5.7" />
	</target>

	<target name="functional-upgrade-wildfly160-mariadb102-jdk8">
		<run-functional-test app.server.type="wildfly" database.type="mariadb" />
	</target>

	<target name="functional-upgrade-wildfly160-mariadb102-jdk11_open">
		<run-functional-test app.server.type="wildfly" database.type="mariadb" />
	</target>

	<target name="functional-weblogic122-oracle122-jdk8">
		<run-functional-test app.server.type="weblogic" database.type="oracle" />
	</target>

	<target name="functional-weblogic122-oracle193-jdk8">
		<run-functional-test app.server.type="weblogic" database.type="oracle" database.version="19.3.0.0.0" />
	</target>

	<target name="functional-wildfly160-mariadb102-jdk8">
		<run-functional-test app.server.type="wildfly" database.type="mariadb" />
	</target>

	<target name="gradle-plugins-test-jdk8">
		<run-batch-test>
			<test-action>
				<for keepgoing="true" param="gradle.plugin.dir">
					<path>
						<dirset
							dir="modules/sdk"
							excludes="${gradle.plugins.test.excludes}"
							includes="gradle-plugins-*"
						/>
					</path>
					<sequential>
						<if>
							<resourcecontains
								resource="@{gradle.plugin.dir}/build.gradle"
								substring="gradleTest"
							/>
							<then>
								<gradle-execute dir="@{gradle.plugin.dir}" task="gradleTest" />
							</then>
						</if>
					</sequential>
				</for>
			</test-action>
		</run-batch-test>
	</target>

	<target name="javadoc-jdk8">
		<run-batch-test>
			<test-action>
				<antcall target="compile" />

				<antcall target="doc" />
			</test-action>
		</run-batch-test>
	</target>

	<target name="js-unit-jdk8">
		<run-batch-test>
			<test-action>
				<for keepgoing="true" param="js.test.dir">
					<path>
						<dirset
							dir="modules"
							excludes="dxp/**,node_modules/**,**/node_modules/**,${base.dir}/**/test/stories/**"
							includes="**/test"
						/>
					</path>
					<sequential>
						<if>
							<resourcecontains
								resource="@{js.test.dir}/../package.json"
								substring="&quot;test&quot;:"
							/>
							<then>
								<var name="js.project.dir.native" unset="true" />
								<var name="js.project.dir.unix" unset="true" />

								<dirname file="@{js.test.dir}" property="js.project.dir.native" />

								<pathconvert property="js.project.dir.unix" targetos="unix">
									<path location="${js.project.dir.native}" />
								</pathconvert>

								<propertyregex
									global="false"
									input="${js.project.dir.unix}"
									override="yes"
									property="js.project.path"
									regexp="^.*/modules(/.*)"
									select="\1"
								/>

								<propertyregex
									global="true"
									input="${js.project.path}"
									override="yes"
									property="js.project.path"
									regexp="/"
									replace=":"
								/>

								<echo message="Executing Gradle task: ${js.project.path}:packageRunTest" />

								<gradle-execute dir="modules" task="${js.project.path}:packageRunTest">
									<arg value="-DpackageRunTest.ignore.failures=true" />
								</gradle-execute>
							</then>
						</if>
					</sequential>
				</for>

				<replace
					dir="modules"
					includes="**/TEST-frontend-js.xml"
				>
					<replacefilter>
						<replacetoken><![CDATA[<testsuites>]]></replacetoken>
						<replacevalue><![CDATA[]]></replacevalue>
					</replacefilter>
					<replacefilter>
						<replacetoken><![CDATA[</testsuites>]]></replacetoken>
						<replacevalue><![CDATA[]]></replacevalue>
					</replacefilter>
				</replace>
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="js-unit-private-jdk8">
		<run-batch-test>
			<test-action>
				<gradle-execute dir="modules/dxp" task="packageRunTest">
					<arg value="--continue" />
					<arg value="--parallel" />
					<arg value="-DpackageRunTest.ignore.failures=true" />
				</gradle-execute>

				<replace
					dir="modules"
					includes="**/TEST-frontend-js.xml"
				>
					<replacefilter>
						<replacetoken><![CDATA[<testsuites>]]></replacetoken>
						<replacevalue><![CDATA[]]></replacevalue>
					</replacefilter>
					<replacefilter>
						<replacetoken><![CDATA[</testsuites>]]></replacetoken>
						<replacevalue><![CDATA[]]></replacevalue>
					</replacefilter>
				</replace>
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="jsf-jdk8">
		<ant antfile="build-test-batch/jsf.xml" target="jsf-jdk8" />
	</target>

	<target name="jsp-runtime-compile-jdk8">
		<run-batch-test>
			<test-action>
				<database-test-run-test database.type="mysql" stop.app.server="true">
					<test-action>
						<delete dir="${liferay.home}/work" />

						<antcall inheritAll="false" target="prepare-log4j-ext-xml" />

						<antcall inheritAll="false" target="prepare-portal-ext-properties" />

						<antcall inheritall="false" target="start-app-server" />

						<trycatch>
							<try>
								<antcall inheritall="false" target="run-selenium-test">
									<param name="test.class" value="PortalSmoke#Smoke" />
								</antcall>
							</try>
							<finally>
								<antcall target="stop-app-server" />
							</finally>
						</trycatch>
					</test-action>
				</database-test-run-test>
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="legacy-functional-bundle-tomcat-db2">
		<run-legacy-database-dump database.type="db2" />
	</target>

	<target name="legacy-functional-bundle-tomcat-mariadb">
		<run-legacy-database-dump database.type="mariadb" />
	</target>

	<target name="legacy-functional-bundle-tomcat-mysql">
		<run-legacy-database-dump database.type="mysql" />
	</target>

	<target name="legacy-functional-bundle-tomcat-oracle">
		<run-legacy-database-dump database.type="oracle" />
	</target>

	<target name="legacy-functional-bundle-tomcat-postgresql">
		<run-legacy-database-dump database.type="postgresql" />
	</target>

	<target name="legacy-functional-bundle-tomcat-sybase">
		<run-legacy-database-dump database.type="sybase" />
	</target>

	<target name="lpkg-base-jdk8">
		<run-lpkg-base-test />
	</target>

	<target name="lpkg-container-jdk8">
		<run-lpkg-container-test />
	</target>

	<target name="lpkg-controller-jdk8">
		<run-lpkg-controller-test />
	</target>

	<target name="lpkg-independence-jdk8">
		<run-lpkg-independence-test />
	</target>

	<target name="lpkg-override-jdk8">
		<run-lpkg-override-test />
	</target>

	<target name="lpkg-persistence-jdk8">
		<run-lpkg-persistence-test />
	</target>

	<target name="lpkg-release-jdk8">
		<run-lpkg-release-test />
	</target>

	<target name="lpkg-startup-jdk8">
		<run-lpkg-startup-test />
	</target>

	<target name="modules-compile-jdk8">
		<run-batch-test>
			<test-action>
				<if>
					<not>
						<isset property="modules.test.class.group" />
					</not>
					<then>
						<gradle-execute dir="modules" outputproperty="modules.project.paths" task="printProjectPath">
							<arg value="--quiet" />
							<arg value="-Dbuild.exclude.dirs=private/apps/osb-lcs,third-party" />
						</gradle-execute>

						<loadresource property="modules.test.class.group">
							<filterchain>
								<linecontainsregexp>
									<regexp pattern="^:" />
								</linecontainsregexp>

								<suffixlines suffix=":assemble " />

								<striplinebreaks />
							</filterchain>
							<propertyresource name="modules.project.paths" />
						</loadresource>
					</then>
				</if>

				<loadresource property="modules.compile.task.groups">
					<filterchain>
						<replacestring from="-test:assemble" to="-test:compileTestIntegrationJava" />

						<tokenfilter>
							<replaceregex flags="g" pattern="(\S+ ){${test.module.groups.size}}" replace="\0," />
						</tokenfilter>
					</filterchain>
					<propertyresource name="modules.test.class.group" />
				</loadresource>

				<for list="${modules.compile.task.groups}" param="modules.compile.task.group" trim="true">
					<sequential>
						<echo>Executing Gradle tasks: @{modules.compile.task.group}.</echo>

						<gradle-execute dir="modules" task="@{modules.compile.task.group}">
							<arg value="--continue" />
							<arg value="--parallel" />
						</gradle-execute>
					</sequential>
				</for>
			</test-action>

			<test-set-up>
				<setup-test-environment />

				<echo>tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/build/system.packages.extra.mf --gzip --to-stdout--verbose  > modules/core/portal-bootstrap/system.packages.extra.mf</echo>

				<execute>
					<![CDATA[
						mkdir -p modules/core/portal-bootstrap

						tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/build/system.packages.extra.mf --gzip --to-stdout --verbose > modules/core/portal-bootstrap/system.packages.extra.mf
					]]>
				</execute>
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="modules-functional-jdk8">
		<run-batch-test>
			<test-action>
				<antcall target="run-selenium-test">
					<param name="test.class" value="${env.RUN_TEST_CASE_METHOD_GROUP}_${axis.variable}" />
				</antcall>
			</test-action>
		</run-batch-test>
	</target>

	<target name="modules-functional-tomcat90-mysql57-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="modules-integration-bundle-db2111-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="db2"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-db2111-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="db2"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-hypersonic20-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="hypersonic"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-hypersonic20-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="hypersonic"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-mariadb102-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="mariadb"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-mariadb102-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="mariadb"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-mysql57-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="mysql"
			database.version="5.7"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-mysql57-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="mysql"
			database.version="5.7"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-oracle122-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="oracle"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-oracle122-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="oracle"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-oracle193-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="oracle"
			database.version="19.3.0.0.0"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-oracle193-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="oracle"
			database.version="19.3.0.0.0"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-postgresql10-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="postgresql"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-postgresql10-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="postgresql"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-sybase160-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="sybase"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-bundle-sybase160-jdk11_open">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-modules-integration-test
			database.type="sybase"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
			test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
			test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.war.url="${test.portal.bundle.war.url}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="modules-integration-db2111-jdk8">
		<run-modules-integration-test database.type="db2" />
	</target>

	<target name="modules-integration-db2111-jdk11_open">
		<run-modules-integration-test database.type="db2" />
	</target>

	<target name="modules-integration-hypersonic20-jdk8">
		<run-modules-integration-test database.type="hypersonic" />
	</target>

	<target name="modules-integration-hypersonic20-jdk11_open">
		<run-modules-integration-test database.type="hypersonic" />
	</target>

	<target name="modules-integration-mariadb102-jdk8">
		<run-modules-integration-test database.type="mariadb" />
	</target>

	<target name="modules-integration-mariadb102-jdk11_open">
		<run-modules-integration-test database.type="mariadb" />
	</target>

	<target name="modules-integration-mysql56-jdk8">
		<run-modules-integration-test database.type="mysql" />
	</target>

	<target name="modules-integration-mysql57-jdk8">
		<run-modules-integration-test database.type="mysql" database.version="5.7" />
	</target>

	<target name="modules-integration-mysql57-jdk11_open">
		<run-modules-integration-test database.type="mysql" database.version="5.7" />
	</target>

	<target name="modules-integration-oracle122-jdk8">
		<run-modules-integration-test database.type="oracle" />
	</target>

	<target name="modules-integration-oracle122-jdk11_open">
		<run-modules-integration-test database.type="oracle" />
	</target>

	<target name="modules-integration-oracle193-jdk8">
		<run-modules-integration-test database.type="oracle" database.version="19.3.0.0.0" />
	</target>

	<target name="modules-integration-oracle193-jdk11_open">
		<run-modules-integration-test database.type="oracle" database.version="19.3.0.0.0" />
	</target>

	<target name="modules-integration-postgresql10-jdk8">
		<run-modules-integration-test database.type="postgresql" />
	</target>

	<target name="modules-integration-postgresql10-jdk11_open">
		<run-modules-integration-test database.type="postgresql" />
	</target>

	<target name="modules-integration-postgresql11-jdk8">
		<run-modules-integration-test database.type="postgresql" database.version="11" />
	</target>

	<target name="modules-integration-postgresql11-jdk11_open">
		<run-modules-integration-test database.type="postgresql" database.version="11" />
	</target>

	<target name="modules-integration-sybase160-jdk8">
		<run-modules-integration-test database.type="sybase" />
	</target>

	<target name="modules-integration-sybase160-jdk11_open">
		<run-modules-integration-test database.type="sybase" />
	</target>

	<target name="modules-semantic-versioning-jdk8">
		<run-batch-test>
			<test-action>
				<loadresource property="modules.baseline.task.groups">
					<filterchain>
						<tokenfilter>
							<replaceregex flags="g" pattern="(\S+ ){${test.module.groups.size}}" replace="\0," />
						</tokenfilter>
					</filterchain>
					<propertyresource name="modules.test.class.group" />
				</loadresource>

				<for list="${modules.baseline.task.groups}" param="modules.baseline.task.group" trim="true">
					<sequential>
						<echo>Executing Gradle tasks: @{modules.baseline.task.group}.</echo>

						<gradle-execute dir="modules" forcedcacheenabled="false" task="@{modules.baseline.task.group}">
							<arg value="--continue" />
							<arg value="--parallel" />
						</gradle-execute>
					</sequential>
				</for>

				<echo>Checking for baseline log files.</echo>

				<var name="log.files" unset="true" />

				<fileset
					dir="${project.dir}"
					id="log.files"
				>
					<include name="modules/**/baseline.log" />
				</fileset>

				<pathconvert pathsep="," property="log.files" refid="log.files" />

				<for list="${log.files}" param="log.file">
					<sequential>
						<print-file file.name="@{log.file}" />
					</sequential>
				</for>

				<if>
					<not>
						<equals arg1="${log.files}" arg2="" />
					</not>
					<then>
						<fail message="Semantic versioning is incorrect." />
					</then>
				</if>

				<echo>Check for baseline log files completed.</echo>
			</test-action>

			<test-set-up>
				<fail message="Please set the property ${modules.test.class.group}" unless="modules.test.class.group" />

				<if>
					<and>
						<available file="liferay-portal-bundle-${app.server.type}.tar.gz" />
						<available file="liferay-portal-source.tar.gz" />
					</and>
					<then>
						<untar
							compression="gzip"
							dest="."
							src="liferay-portal-bundle-${app.server.type}.tar.gz"
						/>

						<antcall inheritAll="false" target="compile" />

						<antcall inheritAll="false" target="install-portal-snapshots" />

						<echo>tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/build/system.packages.extra.mf --gzip --to-stdout --verbose > modules/core/portal-bootstrap/system.packages.extra.mf
tar -zxvf liferay-portal-source.tar.gz --wildcards '*.profile-dxp.properties'</echo>

						<execute>
							<![CDATA[
								mkdir -p modules/core/portal-bootstrap

								tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/build/system.packages.extra.mf --gzip --to-stdout --verbose > modules/core/portal-bootstrap/system.packages.extra.mf

								tar -zxvf liferay-portal-source.tar.gz --wildcards '*.profile-dxp.properties'
							]]>
						</execute>
					</then>
					<else>
						<prepare-test-build />
					</else>
				</if>

				<echo>Deleting stale baseline log files.</echo>

				<for param="log.file">
					<fileset
						dir="${project.dir}"
					>
						<include name="modules/**/baseline.log" />
					</fileset>
					<sequential>
						<delete file="@{log.file}" />
					</sequential>
				</for>
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="modules-unit-jdk8">
		<run-batch-test>
			<test-action>
				<gradle-execute dir="modules" task="test">
					<arg value="--continue" />
					<arg value="-Dbuild.exclude.ant.plugin=true" />
					<arg if:set="com.liferay.portal.search.solr7.test.unit.started" value="-Dcom.liferay.portal.search.solr7.test.unit.started=${com.liferay.portal.search.solr7.test.unit.started}" />
					<arg value="-Djunit.code.coverage=${test.batch.code.coverage}" />
					<arg value="-Dtest.class.group.index=${axis.variable}" />
				</gradle-execute>
			</test-action>

			<test-set-up>
				<setup-test-environment />

				<antcall inheritAll="false" target="record-test-class-file-names">
					<param name="test.class.groups.size" value="${test.batch.size}" />
				</antcall>

				<if>
					<isset property="env.CI_TEST_SUITE" />
					<then>
						<prepare-suite-search-engine suite.name="${env.CI_TEST_SUITE}" />
					</then>
				</if>
			</test-set-up>

			<test-tear-down>
				<stop-suite-search-engine />
			</test-tear-down>
		</run-batch-test>
	</target>

	<target name="modules-unit-project-templates-jdk8">
		<antcall target="modules-unit-jdk8" />
	</target>

	<target name="oracle-service-start">
		<exec executable="service" failonerror="true">
			<arg line="oracledb start" />
		</exec>

		<retry retrycount="60">
			<sequential>
				<local name="output.content" />
				<local name="return.code" />

				<exec executable="${oracle.lsnrctl.executable}" outputproperty="output.content">
					<arg value="services" />
				</exec>

				<echo>Output:
${output.content}</echo>

				<if>
					<or>
						<contains string="${output.content}" substring="The listener supports no services" />
					</or>
					<then>
						<sleep seconds="5" />

						<fail message="Output: ${output.content}" />
					</then>
				</if>
			</sequential>
		</retry>
	</target>

	<target name="oracle-service-stop">
		<exec executable="service">
			<arg line="oracledb stop" />
		</exec>
	</target>

	<target name="patching-tool-custom-scripts-jdk8">
		<fail message="Please set the property liferay.jenkins.dir">
			<condition>
				<not>
					<isset property="liferay.jenkins.dir" />
				</not>
			</condition>
		</fail>

		<run-batch-test>
			<test-action>
				<sequential>
					<trycatch property="failure.message">
						<try>
							<ant antfile="${liferay.jenkins.dir}/commands/custom-scripts/build-test.xml" inheritAll="false" target="run-patching-tool-custom-scripts" />
						</try>
						<catch>
							<fail message="${failure.message}" />
						</catch>
					</trycatch>
				</sequential>
			</test-action>
		</run-batch-test>
	</target>

	<target name="plugins-compile-jdk8">
		<run-batch-test>
			<test-action>
				<ant antfile="build-test-plugins.xml" target="test-plugin-group">
					<property name="test.plugin.group.index" value="${axis.variable}" />
				</ant>
			</test-action>

			<test-set-up>
				<setup-test-environment />

				<antcall inheritAll="false" target="record-test-plugin-names">
					<param name="test.plugin.groups.size" value="${test.batch.size}" />
				</antcall>
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="plugins-functional-bundle-tomcat-mysql56-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="mysql"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="plugins-functional-bundle-tomcat-mysql57-jdk8">
		<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

		<run-functional-test
			app.server.type="tomcat"
			database.type="mysql"
			database.version="5.7"
			test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
			test.fix.pack.base.url="${test.fix.pack.base.url}"
			test.license.xml.url="${test.license.xml.url}"
			test.portal.bundle.version="${test.portal.bundle.version}"
			test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
			test.sql.zip.url="${test.sql.zip.url}"
		/>
	</target>

	<target name="plugins-functional-tomcat90-mysql57-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="plugins-gulp-jdk8">
		<fail message="Please set the property ${test.base.dir.name}" unless="test.base.dir.name" />

		<run-batch-test>
			<test-action>
				<gradle-execute dir="${test.base.dir.name}" task="testJS" />
			</test-action>

			<test-set-up>
				<prepare-test-build />

				<propertyregex
					input="${test.base.dir.name}"
					override="true"
					property="portlet.name"
					regexp=".*/portlets/([a-zA-Z-]+)/?.*"
					replace="\1"
				/>

				<generate-gulp-user-config-json portlet.name="${portlet.name}" />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="pmd-jdk8">
		<local name="pmd.violations.count" />

		<delete dir="pmd-reports" />

		<antcall inheritAll="false" target="compile" />

		<antcall inheritAll="false" target="run-pmd">
			<param name="pmd.java.excludes" value="**/resources/**,**/third-party/**,**/tools/**,**/WEB-INF/**" />
			<param name="pmd.java.includes" value="**/src/**/*.java,**/test/**/*.java,**/testIntegration/**/*.java" />
		</antcall>

		<if>
			<available file="pmd-reports" />
			<then>
				<var name="pmd.violations" value="" />

				<xmltask source="pmd-reports/pmd-report.xml">
					<call path="/pmd/file/violation">
						<param name="beginline" path="@beginline" />
						<param default="" name="externalInfoURL" path="@externalInfoUrl" />
						<param name="fileName" path="../@name" />
						<param name="message" path="text()" />
						<param name="rule" path="@rule" />
						<actions>
							<antelope:stringutil property="message" string="@{message}">
								<antelope:trim />
							</antelope:stringutil>

							<var name="pmd.violations" value="${pmd.violations}${line.separator}PMD VIOLATION: ${basedir}/@{fileName}:@{beginline} > ${message} (PMD Rule: @{rule})${line.separator}" />

							<if>
								<not>
									<equals arg1="@{externalInfoURL}" arg2="" />
								</not>
								<then>
									<var name="pmd.violations" value="${pmd.violations}For more information, please see @{externalInfoURL}.${line.separator}" />
								</then>
							</if>
						</actions>
					</call>
					<copy
						path="count(/pmd/file/violation)"
						property="pmd.violations.count"
					/>
				</xmltask>

				<if>
					<and>
						<isset property="pmd.violations.count" />
						<not>
							<equals arg1="${pmd.violations.count}" arg2="0" />
						</not>
					</and>
					<then>
						<fail message="${pmd.violations.count} PMD violation(s) were found.${line.separator}${pmd.violations}" />
					</then>
				</if>
			</then>
		</if>
	</target>

	<target name="portal-frontend-js-lint-jdk8">
		<run-batch-test>
			<test-action>
				<gradle-execute dir="modules" task="packageRunLint" />
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="portal-license-jdk8">
		<run-batch-test>
			<test-action>
				<sequential>
					<ant dir="${release.tool.dir}" inheritAll="false" target="dist" useNativeBasedir="true">
						<property name="project.release.dir.native" value="${release.tool.dir}" />
					</ant>
				</sequential>
			</test-action>
		</run-batch-test>
	</target>

	<target name="portal-second-startup-space-in-path-jdk8">
		<sequential>
			<run-batch-test>
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<sequential>
								<antcall inheritAll="false" target="prepare-log4j-ext-xml">
									<param name="database.type" value="@{database.type}" />
								</antcall>

								<antcall inheritAll="false" target="prepare-portal-ext-properties">
									<param name="database.type" value="@{database.type}" />
								</antcall>

								<antcall inheritAll="false" target="prepare-system-ext-properties" />

								<antcall inheritAll="false" target="start-app-server">
									<param name="delete.liferay.home" value="false" />
								</antcall>

								<antcall inheritAll="false" target="stop-app-server" />

								<local name="junit.failure.count" />
								<local name="junit.failure.message" />

								<trycatch property="junit.failure.message">
									<try>
										<sequential>
											<antcall inheritAll="false" target="prepare-log4j-ext-xml">
												<param name="database.type" value="@{database.type}" />
											</antcall>

											<antcall inheritAll="false" target="prepare-portal-ext-properties">
												<param name="database.type" value="@{database.type}" />
												<param name="liferay.home" value="${project.dir}/bun dles" />
											</antcall>

											<antcall inheritAll="false" target="prepare-system-ext-properties" />

											<move
												file="bundles"
												tofile="bun dles"
											/>

											<propertyfile file="app.server.${env.HOSTNAME}.properties">
												<entry key="app.server.parent.dir" value="${project.dir}/bun dles" />
											</propertyfile>

											<propertyfile file="build.${env.HOSTNAME}.properties">
												<entry key="liferay.home" value="${project.dir}/bun dles" />
											</propertyfile>

											<antcall inheritAll="false" target="start-app-server">
												<param name="delete.liferay.home" value="false" />
											</antcall>
										</sequential>
									</try>
									<finally>
										<condition else="0" property="junit.failure.count" value="1">
											<isset property="junit.failure.message" />
										</condition>

										<get-junit-failure-message-element />

										<generate-backend-batch-junit-report junit.failure.count="${junit.failure.count}" junit.failure.message.element="${junit.failure.message.element}" test.class.name="PortalSecondStartupSpaceInPath" test.command.name="portalSecondStartupSpaceInPath" />
									</finally>
								</trycatch>

								<antcall inheritall="false" target="stop-app-server" />
							</sequential>
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<setup-test-environment />
				</test-set-up>
			</run-batch-test>
		</sequential>
	</target>

	<target name="portal-startup-space-in-path-jdk8">
		<sequential>
			<run-batch-test>
				<test-action>
					<database-test-run-test database.type="mysql" stop.app.server="true">
						<test-action>
							<local name="junit.failure.count" />
							<local name="junit.failure.message" />

							<trycatch property="junit.failure.message">
								<try>
									<sequential>
										<antcall inheritAll="false" target="prepare-log4j-ext-xml">
											<param name="database.type" value="@{database.type}" />
										</antcall>

										<antcall inheritAll="false" target="prepare-portal-ext-properties">
											<param name="database.type" value="@{database.type}" />
										</antcall>

										<antcall inheritAll="false" target="prepare-system-ext-properties" />

										<antcall inheritAll="false" target="start-app-server" />
									</sequential>
								</try>
								<finally>
									<condition else="0" property="junit.failure.count" value="1">
										<isset property="junit.failure.message" />
									</condition>

									<get-junit-failure-message-element />

									<generate-backend-batch-junit-report
										junit.failure.count="${junit.failure.count}"
										junit.failure.message.element="${junit.failure.message.element}"
										test.class.name="PortalStartupSpaceInPath"
										test.command.name="portalStartupSpaceInPath"
									/>
								</finally>
							</trycatch>

							<antcall inheritall="false" target="stop-app-server" />
						</test-action>
					</database-test-run-test>
				</test-action>

				<test-set-up>
					<if>
						<and>
							<or>
								<matches pattern="(file|https?)://" string="${test.portal.bundle.war.url}" />
								<matches pattern="(file|https?)://" string="${test.portal.bundle.zip.url}" />
							</or>
							<matches pattern="(file|https?)://" string="${test.sql.zip.url}" />
						</and>
						<then>
							<sequential>
								<prepare-release-test-environment
									test.build.fix.pack.zip.url="${test.build.fix.pack.zip.url}"
									test.fix.pack.base.url="${test.fix.pack.base.url}"
									test.license.xml.url="${test.license.xml.url}"
									test.portal.bundle.dependencies.zip.url="${test.portal.bundle.dependencies.zip.url}"
									test.portal.bundle.osgi.zip.url="${test.portal.bundle.osgi.zip.url}"
									test.portal.bundle.tools.zip.url="${test.portal.bundle.tools.zip.url}"
									test.portal.bundle.war.url="${test.portal.bundle.war.url}"
									test.portal.bundle.zip.url="${test.portal.bundle.zip.url}"
									test.sql.zip.url="${test.sql.zip.url}"
								/>

								<propertyfile file="app.server.${env.HOSTNAME}.properties">
									<entry key="app.server.parent.dir" value="${project.dir}/bun dles" />
								</propertyfile>

								<propertyfile file="build.${env.HOSTNAME}.properties">
									<entry key="liferay.home" value="${project.dir}/bun dles" />
								</propertyfile>

								<move
									file="bundles"
									tofile="bun dles"
								/>
							</sequential>
						</then>
						<elseif>
							<and>
								<available file="liferay-portal-bundle-${app.server.type}.tar.gz" />
								<available file="liferay-portal-source.tar.gz" />
							</and>
							<then>
								<sequential>
									<propertyfile file="app.server.${env.HOSTNAME}.properties">
										<entry key="app.server.parent.dir" value="${project.dir}/bun dles" />
									</propertyfile>

									<propertyfile file="build.${env.HOSTNAME}.properties">
										<entry key="liferay.home" value="${project.dir}/bun dles" />
									</propertyfile>

									<prepare-test-environment />

									<move
										file="bundles"
										tofile="bun dles"
									/>
								</sequential>
							</then>
						</elseif>
						<else>
							<prepare-test-build />
						</else>
					</if>
				</test-set-up>
			</run-batch-test>
		</sequential>
	</target>

	<target name="portal-web-jdk8">
		<run-batch-test>
			<test-action>
				<database-test-run-test database.type="mysql">
					<test-action>
						<ant dir="portal-web" target="compile-tomcat" />

						<run-poshi-validation />
					</test-action>
				</database-test-run-test>
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="postgresql-service-start">
		<local name="database.type" />

		<property name="database.type" value="postgresql" />

		<get-database-property property.name="database.password" />
		<get-database-property property.name="database.username" />
		<get-database-property property.name="database.version" />

		<retry retrycount="3">
			<sequential>
				<trycatch>
					<try>
						<exec executable="service" failonerror="true">
							<arg line="postgresql-${database.version} stop" />
						</exec>

						<exec executable="service" failonerror="true">
							<arg line="postgresql-${database.version} start" />
						</exec>

						<exec executable="dropdb" outputproperty="output.content" resultproperty="return.code">
							<env key="PGPASSWORD" value="${database.password}" />
							<arg value="dummy" />
							<arg value="--if-exists" />
							<arg value="--username=${database.username}" />
						</exec>

						<local name="output.content" />
						<local name="return.code" />

						<exec executable="createdb" outputproperty="output.content" resultproperty="return.code">
							<env key="PGPASSWORD" value="${database.password}" />
							<arg value="dummy" />
							<arg value="--username=${database.username}" />
						</exec>

						<if>
							<not>
								<equals arg1="${return.code}" arg2="0" />
							</not>
							<then>
								<echo>${output.content}</echo>

								<fail message="createdb failed with return code ${return.code}." />
							</then>
						</if>
					</try>
					<finally>
						<exec executable="dropdb">
							<env key="PGPASSWORD" value="${database.password}" />
							<arg value="dummy" />
							<arg value="--if-exists" />
							<arg value="--username=${database.username}" />
						</exec>
					</finally>
				</trycatch>
			</sequential>
		</retry>
	</target>

	<target name="postgresql-service-stop">
		<local name="database.type" />

		<property name="database.type" value="postgresql" />

		<get-database-property property.name="database.version" />

		<exec executable="service" failonerror="true">
			<arg line="postgresql-${database.version} stop" />
		</exec>
	</target>

	<target name="release-functional-bundle-tomcat-mysql56-jdk8">
		<antcall target="functional-bundle-tomcat-mysql56-jdk8" />
	</target>

	<target name="release-functional-smoke-bundle-tomcat-mysql56-jdk8">
		<antcall target="functional-bundle-tomcat-mysql56-jdk8" />
	</target>

	<target name="release-functional-smoke-bundle-tomcat-mysql57-jdk8">
		<antcall target="functional-bundle-tomcat-mysql57-jdk8" />
	</target>

	<target name="release-functional-smoke-bundle-tomcat-mysql57-jdk11_open">
		<antcall target="functional-bundle-tomcat-mysql57-jdk11_open" />
	</target>

	<target name="release-osgi-state-exploded-test-jdk8">
		<run-release-osgi-state-exploded-test />
	</target>

	<target name="release-osgi-state-lpkg-change-directory-test-jdk8">
		<run-release-osgi-state-lpkg-change-directory-test />
	</target>

	<target name="release-osgi-state-lpkg-test-jdk8">
		<run-release-osgi-state-lpkg-test />
	</target>

	<target name="ruby-sass-compiler-jdk8">
		<antcall if:set="env.JENKINS_HOME" inheritAll="false" target="clean-up-java-processes" />

		<setup-test-environment />

		<echo file="build.${user.name}.properties">sass.compiler.class.name=ruby</echo>

		<antcall inheritAll="false" target="setup-sdk" />

		<antcall inheritAll="false" target="setup-yarn" />

		<record action="start" name="${project.dir}/sass-compiler-log" />

		<gradle-execute dir="modules" task="buildCSS">
			<arg value="-Dbuild.exclude.ant.plugin=true" />
		</gradle-execute>

		<record action="stop" name="${project.dir}/sass-compiler-log" />

		<fail message="The Sass compiler is not using Ruby.">
			<condition>
				<and>
					<not>
						<resourcecontains
							resource="${project.dir}/sass-compiler-log"
							substring="Using Ruby Sass compiler"
						/>
					</not>
					<or>
						<resourcecontains
							resource="${project.dir}/sass-compiler-log"
							substring="Unable to load Ruby compiler, falling back to native"
						/>
						<resourcecontains
							resource="${project.dir}/sass-compiler-log"
							substring="Using native Sass compiler"
						/>
					</or>
				</and>
			</condition>
		</fail>
	</target>

	<target name="semantic-versioning-jdk8">
		<run-batch-test>
			<test-action>
				<echo>Checking for baseline log files.</echo>

				<var name="log.files" unset="true" />

				<fileset
					dir="${project.dir}"
					id="log.files"
				>
					<include name="baseline-reports/*.log" />
					<include name="modules/**/baseline.log" />
				</fileset>

				<pathconvert pathsep="," property="log.files" refid="log.files" />

				<for list="${log.files}" param="log.file">
					<sequential>
						<print-file file.name="@{log.file}" />
					</sequential>
				</for>

				<if>
					<not>
						<equals arg1="${log.files}" arg2="" />
					</not>
					<then>
						<fail message="Semantic versioning is incorrect." />
					</then>
				</if>

				<echo>Check for baseline log files completed.</echo>
			</test-action>

			<test-set-up>
				<echo>tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/build/system.packages.extra.mf --gzip --verbose
tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/lib/biz.aQute.bnd.annotation.jar --gzip --verbose
tar -zxvf liferay-portal-source.tar.gz --wildcards '*.profile-dxp.properties'
				</echo>

				<execute>
					<![CDATA[
						tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/build/system.packages.extra.mf --gzip --verbose
						tar --extract --file=liferay-portal-source.tar.gz modules/core/portal-bootstrap/lib/biz.aQute.bnd.annotation.jar --gzip --verbose
						tar -zxvf liferay-portal-source.tar.gz --wildcards '*.profile-dxp.properties'
					]]>
				</execute>

				<echo>Deleting stale baseline log files.</echo>

				<for param="log.file">
					<fileset
						dir="${project.dir}"
					>
						<include name="baseline-reports/*.log" />
						<include name="modules/**/baseline.log" />
					</fileset>
					<sequential>
						<delete file="@{log.file}" />
					</sequential>
				</for>

				<echo file="build.${user.name}.properties">baseline.jar.report.level=persist</echo>

				<prepare-test-build />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="service-builder-jdk8">
		<run-batch-test>
			<test-action>
				<if>
					<available file="modules/util/portal-tools-service-builder" />
					<then>
						<gradle-execute dir="modules/util/portal-tools-service-builder" task="deploy">
							<arg value="clean" />
						</gradle-execute>
					</then>
				</if>

				<exec executable="git">
					<arg value="add" />
					<arg value="--all" />
				</exec>

				<record action="start" name="${project.dir}/build.services.output.txt" />

				<if>
					<not>
						<equals arg1="${skip.service.builder.full}" arg2="true" />
					</not>
					<then>
						<ant dir="portal-impl" target="build-services">
							<property name="com.liferay.portal.tools.service.builder.ignore.local" value="false" />
						</ant>
					</then>
					<else>
						<if>
							<not>
								<equals arg1="${skip.service.builder.core}" arg2="true" />
							</not>
							<then>
								<ant dir="portal-impl" target="build-service-counter" />
								<ant dir="portal-impl" target="build-service-portal" />
								<ant dir="portal-impl" target="build-service-portlets" />
							</then>
						</if>

						<if>
							<isset property="modules.test.class.group" />
							<then>
								<loadresource property="modules.build.service.tasks">
									<filterchain>
										<tokenfilter>
											<replaceregex flags="g" pattern="(\S+ )" replace="\0," />
										</tokenfilter>
									</filterchain>
									<propertyresource name="modules.test.class.group" />
								</loadresource>

								<for list="${modules.build.service.tasks}" param="modules.build.service.task" trim="true">
									<sequential>
										<echo>Executing Gradle tasks: @{modules.build.service.task}</echo>

										<gradle-execute dir="modules" forcedcacheenabled="false" task="@{modules.build.service.task}">
											<arg value="-DbuildService.skipReadOnly=${build.services.skip.read.only}" />
											<arg value="-Pcom.liferay.portal.tools.service.builder.ignore.local=false" />
										</gradle-execute>
									</sequential>
								</for>
							</then>
						</if>
					</else>
				</if>

				<record action="stop" name="${project.dir}/build.services.output.txt" />

				<loadfile
					property="build.services.output.txt.content"
					srcfile="${project.dir}/build.services.output.txt"
				/>

				<delete file="${project.dir}/build.services.output.txt" />

				<if>
					<contains string="${build.services.output.txt.content}" substring="Writing " />
					<then>
						<exec executable="git" output="${project.dir}/build.services.diff.txt">
							<arg value="diff" />
							<arg value="--" />
							<arg value="." />
							<arg value=":!*/*-portlet-service.jar" />
							<arg value=":!*/packageinfo" />
							<arg value=":!*/src/main/resources/service.properties" />
							<arg value=":!*/src/service.properties" />
						</exec>

						<loadfile
							property="build.services.diff.txt.content"
							srcfile="${project.dir}/build.services.diff.txt"
						/>

						<delete file="${project.dir}/build.services.diff.txt" />

						<if>
							<isset property="build.services.diff.txt.content" />
							<then>
								<echo message="${build.services.diff.txt.content}" />

								<fail>
.

Detected build services changes. See above build services log for more
information. Make sure to commit in all build services results.
								</fail>
							</then>
						</if>
					</then>
				</if>
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="setup-testable-tomcat-gc">
		<setup-testable-tomcat-gc test.portal.bundle.version="${test.portal.bundle.version}" />
	</target>

	<target name="source-format-current-branch-jdk8">
		<run-batch-test>
			<test-action>
				<exec executable="git" failonerror="true" outputproperty="git.diff">
					<arg value="diff" />
					<arg value="--name-only" />
					<arg value="${liferay.portal.branch}..HEAD" />
				</exec>

				<var name="format.current.branch" value="true" />

				<if>
					<contains string="${git.diff}" substring="modules${file.separator}util${file.separator}source-formatter" />
					<then>
						<var name="format.current.branch" value="false" />

						<antcall target="compile" />

						<antcall target="install-portal-snapshots" />

						<if>
							<available file="modules/util/source-formatter" />
							<then>
								<gradle-execute dir="modules/util/source-formatter" task="deploy" />
							</then>
						</if>
					</then>
					<else>
						<antcall target="setup-sdk" />

						<antcall target="setup-yarn" />
					</else>
				</if>

				<ant dir="portal-impl" target="format-source-all">
					<property name="format.current.branch" value="${format.current.branch}" />
					<property name="show.documentation" value="false" />
					<property name="source.auto.fix" value="false" />
					<property name="source.print.errors" value="false" />
					<property name="source.throw.exception" value="true" />
					<property name="source.use.properties" value="false" />
				</ant>
			</test-action>
		</run-batch-test>
	</target>

	<target name="source-format-jdk8">
		<run-batch-test>
			<test-action>
				<if>
					<available file="modules/util/source-formatter" />
					<then>
						<gradle-execute dir="modules/util/source-formatter" task="deploy">
							<arg value="clean" />
						</gradle-execute>
					</then>
				</if>

				<loadproperties>
					<zipentry name="META-INF/MANIFEST.MF" zipfile="tools/sdk/dependencies/com.liferay.source.formatter/lib/com.liferay.source.formatter.jar" />
				</loadproperties>

				<echo>Running com.liferay.source.formatter.jar ${Bundle-Version}.</echo>

				<ant dir="portal-impl" target="format-source-all">
					<property name="show.documentation" value="false" />
					<property name="source.auto.fix" value="false" />
					<property if:true="${liferay.releng.public}" name="source.formatter.excludes" value="modules/private/**" />
					<property name="source.print.errors" value="false" />
					<property name="source.throw.exception" value="true" />
					<property name="source.use.properties" value="false" />
				</ant>
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="subrepository-assemble-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<run-batch-test tomcat.gc.log="true">
			<test-action>
				<get-module-base-dir-from-subrepository-name subrepository.name="${subrepository.name}" />

				<trycatch property="failure.property">
					<try>
						<gradle-execute checktask="true" dir="${module.base.dir}" outputproperty="gradle.output" refreshdependencies="true" task="assemble" />
					</try>
					<catch>
						<echo message="${gradle.output.error}" />

						<fail message="${failure.property}" />
					</catch>
				</trycatch>
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="subrepository-compile-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<get-module-base-dir-from-subrepository-name subrepository.name="${subrepository.name}" />

		<trycatch property="failure.property">
			<try>
				<gradle-execute checktask="true" dir="${module.base.dir}" outputproperty="gradle.output" refreshdependencies="true" task="compileJava" />
			</try>
			<catch>
				<echo message="${gradle.output.error}" />

				<fail message="${failure.property}" />
			</catch>
		</trycatch>
	</target>

	<target name="subrepository-functional-tomcat90-mysql57-jdk8">
		<run-functional-test app.server.type="tomcat" database.type="mysql" database.version="5.7" />
	</target>

	<target name="subrepository-integration-mysql56-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<run-modules-integration-test database.type="mysql" refreshdependencies="true" subrepository.name="${subrepository.name}" />
	</target>

	<target name="subrepository-integration-mysql57-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<run-modules-integration-test database.type="mysql" database.version="5.7" refreshdependencies="true" subrepository.name="${subrepository.name}" />
	</target>

	<target name="subrepository-pmd-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<get-module-base-dir-from-subrepository-name subrepository.name="${subrepository.name}" />

		<trycatch property="failure.property">
			<try>
				<gradle-execute checktask="true" dir="${module.base.dir}" outputproperty="gradle.output" refreshdependencies="true" task="pmdMain">
					<arg value="pmdTest" />
					<arg value="pmdTestIntegration" />
				</gradle-execute>
			</try>
			<catch>
				<echo message="${gradle.output.error}" />

				<fail message="${failure.property}" />
			</catch>
		</trycatch>
	</target>

	<target name="subrepository-semantic-versioning-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<get-module-base-dir-from-subrepository-name subrepository.name="${subrepository.name}" />

		<echo>Deleting stale baseline log files.</echo>

		<delete failonerror="false">
			<fileset
				dir="${project.dir}"
			>
				<include name="baseline-reports/*.log" />
				<include name="modules/**/baseline.log" />
			</fileset>
		</delete>

		<echo file="build.${user.name}.properties">baseline.jar.report.level=persist</echo>

		<echo>Executing baseline on ${module.base.dir}.</echo>

		<trycatch property="failure.property">
			<try>
				<gradle-execute checktask="true" dir="${module.base.dir}" forcedcacheenabled="false" outputproperty="gradle.output" refreshdependencies="true" task="baseline" />
			</try>
			<catch>
				<echo message="${gradle.output.error}" />

				<fail message="${failure.property}" />
			</catch>
		</trycatch>

		<echo>Checking for baseline log files.</echo>

		<var name="log.files" unset="true" />

		<fileset
			dir="${project.dir}"
			id="log.files"
		>
			<include name="baseline-reports/*.log" />
			<include name="modules/**/baseline.log" />
		</fileset>

		<pathconvert pathsep="," property="log.files" refid="log.files" />

		<for list="${log.files}" param="log.file">
			<sequential>
				<print-file file.name="@{log.file}" />
			</sequential>
		</for>

		<if>
			<not>
				<equals arg1="${log.files}" arg2="" />
			</not>
			<then>
				<fail message="Semantic versioning is incorrect." />
			</then>
		</if>

		<echo>Check for baseline log files completed.</echo>
	</target>

	<target name="subrepository-source-format-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<get-module-base-dir-from-subrepository-name subrepository.name="${subrepository.name}" />

		<trycatch property="failure.property">
			<try>
				<gradle-execute dir="${module.base.dir}" outputproperty="gradle.output" refreshdependencies="true" task="checkSourceFormatting">
					<arg value="-PdependencyCheckerIgnoreFailures=false" />
				</gradle-execute>
			</try>
			<catch>
				<echo message="${gradle.output.error}" />

				<fail message="${failure.property}" />
			</catch>
		</trycatch>
	</target>

	<target name="subrepository-unit-jdk8">
		<fail message="Please set the property ${subrepository.name}." unless="subrepository.name" />

		<trycatch property="failure.property">
			<try>
				<gradle-execute dir="${project.dir}/modules/apps/petra" task="deploy">
					<arg value="-Dportal.build=true" />
				</gradle-execute>

				<if>
					<equals arg1="${subrepository.validation}" arg2="true" />
					<then>
						<get-module-base-dir-from-subrepository-name subrepository.name="${subrepository.name}" />

						<move
							file="${module.base.dir}/settings.gradle"
							tofile="${module.base.dir}/settings.gradle.temp"
							verbose="true"
						/>

						<gradle-execute checktask="true" dir="${module.base.dir}" forcedcacheenabled="false" outputproperty="gradle.output" refreshdependencies="true" task="test" />

						<move
							file="${module.base.dir}/settings.gradle.temp"
							tofile="${module.base.dir}/settings.gradle"
						/>
					</then>
					<else>
						<antcall inheritAll="false" target="record-test-class-file-names">
							<param name="test.class.groups.size" value="${test.batch.size}" />
						</antcall>

						<gradle-execute checktask="true" dir="modules" forcedcacheenabled="false" outputproperty="gradle.output" refreshdependencies="true" task="test">
							<arg value="-Dbuild.exclude.ant.plugin=true" />
							<arg value="-Dtest.class.group.index=${axis.variable}" />
						</gradle-execute>
					</else>
				</if>
			</try>
			<catch>
				<echo message="${gradle.output.error}" />

				<fail message="${failure.property}" />
			</catch>
		</trycatch>

		<merge-test-results />
	</target>

	<target name="sybase-service-start">
		<local name="database.type" />

		<property name="database.type" value="sybase" />

		<get-database-property property.name="database.password" />
		<get-database-property property.name="database.schema" />
		<get-database-property property.name="database.username" />

		<condition else="false" property="rebuild.sybase" value="true">
			<length length="25000000000" mode="all" when="lt">
				<fileset
					dir="/opt/sybase/data"
					includes="*"
				/>
			</length>
		</condition>

		<if>
			<not>
				<equals arg1="${rebuild.sybase}" arg2="true" />
			</not>
			<then>
				<clean-restart-sybase retry="true" />
			</then>
			<else>
				<clean-restart-sybase />
			</else>
		</if>

		<echo file="create-header.sql">use master
dump transaction master with no_log
go
disk resize name="master", size="750m"
go
drop database lportal
go
exec sp_configure 'lock scheme', 0, datarows
go
exec sp_configure 'procedure cache size', 28000
go
create database lportal on master = "750m"
go
exec sp_dboption 'lportal', 'allow nulls by default' , true
go
exec sp_dboption 'lportal', 'select into/bulkcopy/pllsort' , true
go
exec sp_dboption 'lportal', 'trunc log on chkpt', true
go</echo>

		<retry retrycount="10">
			<sequential>
				<set-sybase-charset-utf8 />

				<if>
					<not>
						<available file="/opt/sybase/charsets" />
					</not>
					<then>
						<clean-restart-sybase retry="true" />

						<fail message="Missing /opt/sybase/charsets." />
					</then>
				</if>

				<local name="output.content" />
				<local name="return.code" />

				<exec executable="${sybase.executable}" outputproperty="output.content" resultproperty="return.code">
					<arg value="-i" />
					<arg value="create-header.sql" />
					<arg value="-P" />
					<arg value="${database.password}" />
					<arg value="-S" />
					<arg value="${database.schema}" />
					<arg value="-U" />
					<arg value="${database.username}" />
				</exec>

				<echo>Return code: ${return.code}
Output:
${output.content}</echo>

				<if>
					<or>
						<contains string="${output.content}" substring="Database 'lportal' already exists" />
						<contains string="${output.content}" substring="sp_dboption" />
						<contains string="${output.content}" substring="The model database is unavailable. It is being used to create a new database." />
					</or>
					<then>
						<clean-restart-sybase retry="true" />

						<fail message="Output: ${output.content}" />
					</then>
				</if>

				<if>
					<not>
						<equals arg1="${return.code}" arg2="0" />
					</not>
					<then>
						<clean-restart-sybase retry="true" />

						<fail message="Return code: ${return.code}" />
					</then>
				</if>
			</sequential>
		</retry>

		<delete file="create-header.sql" />
	</target>

	<target name="sybase-service-stop">
		<exec executable="service">
			<arg line="sybase stop" />
		</exec>

		<waitfor maxwait="60" maxwaitunit="second">
			<not>
				<socket port="5000" server="localhost" />
			</not>
		</waitfor>

		<antcall target="clean-up-sybase-processes" />
	</target>

	<target name="tck-jdk8">
		<run-batch-test tomcat.gc.log="true" tsant.gc.log="true">
			<test-action>
				<database-test-run-test database.type="mysql" stop.app.server="true">
					<test-action>
						<ant antfile="build-test-tck.xml" target="prepare-tck" />

						<ant antfile="build-test-tck.xml" target="prepare-tck-app-server" />

						<ant antfile="build-test-tck.xml" target="run-tck-tests" />

						<ant antfile="build-test-tck.xml" target="clean-up-tck" />
					</test-action>
				</database-test-run-test>
			</test-action>

			<test-set-up>
				<set-tomcat-version-number liferay.portal.bundle="${test.portal.bundle.version}" />

				<setup-test-environment />

				<antcall target="prepare-portal-ext-properties">
					<param name="hot.deploy.dependency.management.enabled" value="false" />
				</antcall>

				<antcall target="prepare-system-ext-properties" />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="unit-jdk8">
		<run-batch-test>
			<test-action>
				<ant dir="portal-kernel" inheritAll="false" target="test-class-group">
					<property name="junit.code.coverage" value="${test.batch.code.coverage}" />
					<property name="test.class.group.index" value="${axis.variable}" />
				</ant>

				<ant dir="portal-impl" inheritAll="false" target="test-class-group">
					<property name="junit.code.coverage" value="${test.batch.code.coverage}" />
					<property name="test.class.group.index" value="${axis.variable}" />
					<property name="test.type" value="unit" />
				</ant>

				<ant dir="util-java" inheritAll="false" target="test-class-group">
					<property name="junit.code.coverage" value="${test.batch.code.coverage}" />
					<property name="test.class.group.index" value="${axis.variable}" />
				</ant>
			</test-action>

			<test-set-up>
				<setup-test-environment />

				<antcall inheritAll="false" target="record-test-class-file-names">
					<param name="test.class.groups.size" value="${test.batch.size}" />
				</antcall>

				<delete dir="${liferay.home}/osgi/static" />
				<delete file="${app.server.lib.portal.dir}/util-taglib.jar" />
			</test-set-up>
		</run-batch-test>
	</target>

	<target name="wsdd-builder-jdk8">
		<run-batch-test>
			<test-action>
				<ant dir="portal-impl" target="build-wsdds" />
			</test-action>

			<test-set-up>
				<setup-test-environment />
			</test-set-up>
		</run-batch-test>
	</target>
</project>